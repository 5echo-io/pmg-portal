{% extends "admin/base.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'app.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'admin_custom.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} admin-page{% endblock %}

{% block header %}
<header class="topbar">
  <div class="topbar-left">
    <div class="brand">PMG Portal</div>
    <div class="topbar-nav">
      <a class="topbar-btn {% if request.path == '/' %}active{% endif %}" href="/">Portal</a>
      {% if request.user.is_superuser %}
      <a class="topbar-btn {% if request.path|slice:':7' == '/admin/' %}active{% endif %}" href="/admin/">Admin</a>
      {% endif %}
    </div>
  </div>
  <div class="topbar-right">
    <button id="recent-actions-btn" class="admin-icon-btn" title="Recent Actions">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    </button>
    <div class="user-avatar-wrapper">
      <button class="user-avatar-btn" onclick="toggleUserMenu(event)" aria-label="User menu">
        <div class="user-avatar">
          {{ request.user.username|first|upper }}
        </div>
      </button>
      <div id="user-menu" class="user-menu">
        <div class="user-menu-header">
          <div class="user-menu-name">{% if request.user.first_name or request.user.last_name %}{{ request.user.first_name }} {{ request.user.last_name }}{% else %}{{ request.user.username }}{% endif %}</div>
          <div class="user-menu-email">{{ request.user.email|default:"" }}</div>
        </div>
        <div class="user-menu-divider"></div>
        <a href="/account/profile/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Profile Settings
        </a>
        {% if request.user.is_superuser %}
        <div class="user-menu-divider"></div>
        <a href="/admin/" class="user-menu-item">
          <!-- Admin Panel SVG -->
          Admin Panel
        </a>
        <a href="/debug/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          Debug
        </a>
        {% endif %}
        <div class="user-menu-divider"></div>
        <a href="/accounts/logout/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Logout
        </a>
      </div>
    </div>
  </div>
</header>

<!-- Recent Actions Modal -->
<div id="recent-actions-modal" class="admin-modal" onclick="closeRecentActionsModal(event)">
  <div class="admin-modal-content" onclick="event.stopPropagation()">
    <div class="admin-modal-header">
      <h2>Recent Actions</h2>
      <button class="admin-modal-close" onclick="closeRecentActionsModal(event)">&times;</button>
    </div>
    <div class="admin-modal-body">
      <div id="recent-actions-list" class="recent-actions-list">
        <p class="muted">Loading recent actions...</p>
      </div>
    </div>
  </div>
</div>

<script>
function toggleUserMenu(event) {
  event.stopPropagation();
  const menu = document.getElementById('user-menu');
  if (menu) {
    menu.classList.toggle('open');
  }
}

document.addEventListener('click', function(event) {
  const menu = document.getElementById('user-menu');
  const avatarBtn = document.querySelector('.user-avatar-btn');
  if (menu && avatarBtn && !menu.contains(event.target) && !avatarBtn.contains(event.target)) {
    menu.classList.remove('open');
  }
});

function openRecentActionsModal() {
  const modal = document.getElementById('recent-actions-modal');
  if (modal) {
    modal.style.display = 'flex';
    loadRecentActions();
  }
}

function loadRecentActions() {
  const list = document.getElementById('recent-actions-list');
  if (!list) return;
  
  fetch('/admin/actions/')
    .then(response => response.json())
    .then(data => {
      if (!data.actions || data.actions.length === 0) {
        list.innerHTML = '<p class="muted">No recent actions.</p>';
        return;
      }
      
      let htmlContent = '<div class="recent-actions-container">';
      data.actions.forEach(action => {
        htmlContent += `
          <div class="recent-action-item">
            <div class="recent-action-icon">${getActionIcon(action.action_flag)}</div>
            <div class="recent-action-content">
              <div class="recent-action-text">${action.content_type_name}: <a href="${action.url}">${action.object_repr}</a></div>
              <div class="recent-action-time">${action.action_time}</div>
            </div>
          </div>
        `;
      });
      htmlContent += '</div>';
      list.innerHTML = htmlContent;
    })
    .catch(error => {
      list.innerHTML = '<p class="muted">Unable to load recent actions.</p>';
      console.error('Error loading recent actions:', error);
    });
}

function closeRecentActionsModal(event) {
  if (!event || event.target.id === 'recent-actions-modal' || event.target.classList.contains('admin-modal-close')) {
    const modal = document.getElementById('recent-actions-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
}

function getActionIcon(actionText) {
  if (actionText.includes('Added') || actionText.includes('added')) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>';
  } else if (actionText.includes('Changed') || actionText.includes('changed')) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
  } else if (actionText.includes('Deleted') || actionText.includes('deleted')) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>';
  }
  return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>';
}

// Make functions globally accessible immediately
window.openRecentActionsModal = openRecentActionsModal;
window.closeRecentActionsModal = closeRecentActionsModal;
window.toggleUserMenu = toggleUserMenu;
window.getActionIcon = getActionIcon;

// Attach event listener to button (runs after DOM is ready)
(function() {
  function attachRecentActionsHandler() {
    const btn = document.getElementById('recent-actions-btn');
    if (btn) {
      // Remove any existing listeners by cloning the button
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (typeof openRecentActionsModal === 'function') {
          openRecentActionsModal();
        } else {
          console.error('openRecentActionsModal function not available');
        }
      });
    }
  }
  
  // Try immediately
  attachRecentActionsHandler();
  
  // Also try on DOMContentLoaded in case script runs before DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachRecentActionsHandler);
  }
})();

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeRecentActionsModal();
    document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
  }
});

// Enforce static admin sidebar (no toggle) and fix sidebar hidden after back/forward
(function() {
  function enforceNavSidebar() {
    const body = document.body;
    const toggle = document.getElementById('toggle-nav-sidebar');
    const navSidebar = document.getElementById('nav-sidebar');

    if (body) {
      body.classList.remove('nav-sidebar-collapsed');
    }
    try {
      if (typeof sessionStorage !== 'undefined') {
        sessionStorage.removeItem('django.admin.navSidebarIsOpen');
      }
    } catch (e) {}

    if (toggle) {
      toggle.remove();
    }

    if (navSidebar) {
      navSidebar.style.display = 'block';
      navSidebar.removeAttribute('hidden');
    }
  }

  function initNavSidebarCollapse() {
    const nav = document.getElementById('nav-sidebar');
    if (!nav) return;
    var modules = nav.querySelectorAll('.module');
    modules.forEach(function(mod) {
      mod.classList.add('collapsed');
      var cap = mod.querySelector('caption');
      var h2 = mod.querySelector('h2');
      var header = cap || h2;
      if (header) {
        header.setAttribute('role', 'button');
        header.setAttribute('aria-expanded', 'false');
        header.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          var open = !mod.classList.toggle('collapsed');
          header.setAttribute('aria-expanded', open ? 'true' : 'false');
        });
        var link = header.querySelector('a');
        if (link) {
          link.addEventListener('click', function(e) { e.preventDefault(); });
        }
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      enforceNavSidebar();
      initNavSidebarCollapse();
    });
  } else {
    enforceNavSidebar();
    initNavSidebarCollapse();
  }

  window.addEventListener('load', function() {
    enforceNavSidebar();
    initNavSidebarCollapse();
  });
  window.addEventListener('pageshow', function(ev) {
    if (ev.persisted) {
      enforceNavSidebar();
    }
  });
  setTimeout(enforceNavSidebar, 100);
  setTimeout(enforceNavSidebar, 300);
})();

// Frontend logging for admin pages (same as portal)
(function() {
  window.pmgDebugLogs = window.pmgDebugLogs || [];
  const MAX_LOGS = 100;

  function logEvent(type, data) {
    const logEntry = {
      timestamp: new Date().toISOString(),
      type: type,
      data: data,
      url: window.location.pathname,
      userAgent: navigator.userAgent,
    };
    window.pmgDebugLogs.push(logEntry);
    if (window.pmgDebugLogs.length > MAX_LOGS) {
      window.pmgDebugLogs.shift();
    }
    console.debug('[PMG Debug]', type, data);
  }

  // Log button/link clicks
  document.addEventListener('click', function(e) {
    const target = e.target;
    if (target.tagName === 'BUTTON' || target.tagName === 'A' || target.closest('button') || target.closest('a')) {
      const element = target.closest('button') || target.closest('a') || target;
      logEvent('click', {
        element: element.tagName,
        id: element.id || null,
        className: element.className || null,
        text: element.textContent?.trim().substring(0, 50) || null,
        href: element.href || null,
      });
    }
  });

  // Log form submissions
  document.addEventListener('submit', function(e) {
    logEvent('form_submit', {
      formId: e.target.id || null,
      action: e.target.action || null,
      method: e.target.method || 'GET',
    });
  });

  // Log page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      logEvent('page_load', {
        readyState: document.readyState,
        loadTime: performance.timing ? performance.timing.loadEventEnd - performance.timing.navigationStart : null,
      });
    });
  } else {
    logEvent('page_load', {
      readyState: document.readyState,
      loadTime: performance.timing ? performance.timing.loadEventEnd - performance.timing.navigationStart : null,
    });
  }

  // Log JavaScript errors
  window.addEventListener('error', function(e) {
    logEvent('javascript_error', {
      message: e.message,
      filename: e.filename,
      lineno: e.lineno,
      colno: e.colno,
      error: e.error ? e.error.toString() : null,
    });
  });

  // Log unhandled promise rejections
  window.addEventListener('unhandledrejection', function(e) {
    logEvent('promise_rejection', {
      reason: e.reason ? e.reason.toString() : 'Unknown',
    });
  });

  // Log fetch requests
  if (window.fetch && !window.__pmgFetchWrapped) {
    const originalFetch = window.fetch;
    window.fetch = function(input, init) {
      const url = typeof input === 'string' ? input : input.url;
      const method = (init && init.method) || 'GET';
      logEvent('fetch_start', { url: url, method: method });
      return originalFetch.apply(this, arguments)
        .then(function(response) {
          logEvent('fetch_end', { url: url, method: method, status: response.status });
          return response;
        })
        .catch(function(error) {
          logEvent('fetch_error', { url: url, method: method, error: error ? error.toString() : 'Unknown' });
          throw error;
        });
    };
    window.__pmgFetchWrapped = true;
  }

  // Log XHR requests
  if (window.XMLHttpRequest && !window.__pmgXhrWrapped) {
    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSend = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.open = function(method, url) {
      this.__pmgMethod = method;
      this.__pmgUrl = url;
      return originalOpen.apply(this, arguments);
    };
    XMLHttpRequest.prototype.send = function() {
      const xhr = this;
      logEvent('xhr_start', { url: xhr.__pmgUrl, method: xhr.__pmgMethod });
      xhr.addEventListener('load', function() {
        logEvent('xhr_end', { url: xhr.__pmgUrl, method: xhr.__pmgMethod, status: xhr.status });
      });
      xhr.addEventListener('error', function() {
        logEvent('xhr_error', { url: xhr.__pmgUrl, method: xhr.__pmgMethod, status: xhr.status });
      });
      return originalSend.apply(this, arguments);
    };
    window.__pmgXhrWrapped = true;
  }

  // Make logs accessible globally
  window.getPmgDebugLogs = function() {
    return window.pmgDebugLogs;
  };
})();
</script>
{% endblock %}

{% block footer %}
<div class="admin-footer-wrapper">
<footer class="footer">
  {% include "includes/site_footer.html" %}
</footer>
</div>

{% if show_changelog_button %}
<!-- Changelog Modal -->
<div id="changelogModal" class="modal" onclick="closeChangelogModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2>Changelog - Version {{ app_version|default:"Unknown" }}</h2>
      <button class="modal-close" onclick="closeChangelogModal(event)">&times;</button>
    </div>
    <div class="modal-body">
      {% if changelog_section %}
      <div class="footer-changelog">{{ changelog_section|safe }}</div>
      {% else %}
      <p class="muted">No changelog available for this version.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
function openChangelogModal() {
  const modal = document.getElementById('changelogModal');
  if (modal) {
    modal.style.display = 'flex';
  }
}

function closeChangelogModal(event) {
  if (!event || event.target.id === 'changelogModal' || event.target.classList.contains('modal-close')) {
    const modal = document.getElementById('changelogModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
}

document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('changelogModal');
    if (modal && modal.style.display === 'flex') {
      closeChangelogModal(event);
    }
  }
});
</script>
{% endif %}
{% endblock %}
