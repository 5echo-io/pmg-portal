{% extends "admin/base.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'app.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'admin_custom.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} admin-page{% endblock %}

{% block header %}
<header class="topbar">
  <div class="topbar-left">
    <div class="brand">PMG Portal</div>
    <div class="topbar-nav">
      <a class="topbar-btn {% if request.path == '/portal/' or request.path|slice:':8' == '/portal/' %}active{% endif %}" href="/portal/">Portal</a>
      {% if request.user.is_superuser %}
      <a class="topbar-btn {% if request.path|slice:':7' == '/admin/' %}active{% endif %}" href="/admin/">Admin</a>
      {% endif %}
    </div>
  </div>
  <div class="topbar-right">
    <button id="recent-actions-btn" class="admin-icon-btn" title="Recent Actions">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    </button>
    <div class="user-avatar-wrapper">
      <button class="user-avatar-btn" onclick="toggleUserMenu(event)" aria-label="User menu">
        <div class="user-avatar">
          {{ request.user.username|first|upper }}
        </div>
      </button>
      <div id="user-menu" class="user-menu">
        <div class="user-menu-header">
          <div class="user-menu-name">{% if request.user.first_name or request.user.last_name %}{{ request.user.first_name }} {{ request.user.last_name }}{% else %}{{ request.user.username }}{% endif %}</div>
          <div class="user-menu-email">{{ request.user.email|default:"" }}</div>
        </div>
        <div class="user-menu-divider"></div>
        <a href="/account/profile/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Profile Settings
        </a>
        {% if request.user.is_superuser %}
        <div class="user-menu-divider"></div>
        <a href="/admin/" class="user-menu-item">
          <!-- Admin Panel SVG -->
          Admin Panel
        </a>
        <a href="/debug/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          Debug
        </a>
        {% endif %}
        <div class="user-menu-divider"></div>
        <a href="/accounts/logout/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Logout
        </a>
      </div>
    </div>
  </div>
</header>

<!-- Recent Actions Modal -->
<div id="recent-actions-modal" class="admin-modal" onclick="closeRecentActionsModal(event)">
  <div class="admin-modal-content" onclick="event.stopPropagation()">
    <div class="admin-modal-header">
      <h2>Recent Actions</h2>
      <button class="admin-modal-close" onclick="closeRecentActionsModal(event)">&times;</button>
    </div>
    <div class="admin-modal-body">
      <div id="recent-actions-list" class="recent-actions-list">
        <p class="muted">Loading recent actions...</p>
      </div>
    </div>
  </div>
</div>

<script>
function toggleUserMenu(event) {
  event.stopPropagation();
  const menu = document.getElementById('user-menu');
  if (menu) {
    menu.classList.toggle('open');
  }
}

document.addEventListener('click', function(event) {
  const menu = document.getElementById('user-menu');
  const avatarBtn = document.querySelector('.user-avatar-btn');
  if (menu && avatarBtn && !menu.contains(event.target) && !avatarBtn.contains(event.target)) {
    menu.classList.remove('open');
  }
});

function openRecentActionsModal() {
  const modal = document.getElementById('recent-actions-modal');
  if (modal) {
    modal.style.display = 'flex';
    loadRecentActions();
  }
}

function loadRecentActions() {
  const list = document.getElementById('recent-actions-list');
  if (!list) return;
  
  fetch('/admin/actions/')
    .then(response => response.json())
    .then(data => {
      if (!data.actions || data.actions.length === 0) {
        list.innerHTML = '<p class="muted">No recent actions.</p>';
        return;
      }
      
      let htmlContent = '<div class="recent-actions-container">';
      data.actions.forEach(action => {
        htmlContent += `
          <div class="recent-action-item">
            <div class="recent-action-icon">${getActionIcon(action.action_flag)}</div>
            <div class="recent-action-content">
              <div class="recent-action-text">${action.content_type_name}: <a href="${action.url}">${action.object_repr}</a></div>
              <div class="recent-action-time">${action.action_time}</div>
            </div>
          </div>
        `;
      });
      htmlContent += '</div>';
      list.innerHTML = htmlContent;
    })
    .catch(error => {
      list.innerHTML = '<p class="muted">Unable to load recent actions.</p>';
      console.error('Error loading recent actions:', error);
    });
}

function closeRecentActionsModal(event) {
  if (!event || event.target.id === 'recent-actions-modal' || event.target.classList.contains('admin-modal-close')) {
    const modal = document.getElementById('recent-actions-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
}

function getActionIcon(actionText) {
  if (actionText.includes('Added') || actionText.includes('added')) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>';
  } else if (actionText.includes('Changed') || actionText.includes('changed')) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
  } else if (actionText.includes('Deleted') || actionText.includes('deleted')) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>';
  }
  return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>';
}

// Make functions globally accessible immediately
window.openRecentActionsModal = openRecentActionsModal;
window.closeRecentActionsModal = closeRecentActionsModal;
window.toggleUserMenu = toggleUserMenu;
window.getActionIcon = getActionIcon;

// Attach event listener to button (runs after DOM is ready)
(function() {
  function attachRecentActionsHandler() {
    const btn = document.getElementById('recent-actions-btn');
    if (btn) {
      // Remove any existing listeners by cloning the button
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
      
      newBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (typeof openRecentActionsModal === 'function') {
          openRecentActionsModal();
        } else {
          console.error('openRecentActionsModal function not available');
        }
      });
    }
  }
  
  // Try immediately
  attachRecentActionsHandler();
  
  // Also try on DOMContentLoaded in case script runs before DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachRecentActionsHandler);
  }
})();

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeRecentActionsModal();
    document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
  }
});

// STANDARDIZED FOOTER FIX - Ensure footer is at bottom and full width
(function() {
  function fixFooter() {
    const footer = document.querySelector('footer.footer, .footer');
    const body = document.body;
    const html = document.documentElement;
    
    // Ensure html and body use flexbox
    if (html) {
      html.style.cssText = 'height: 100% !important; width: 100% !important; max-width: 100% !important; margin: 0 !important; padding: 0 !important;';
    }
    
    if (body) {
      body.style.cssText = 'min-height: 100vh !important; display: flex !important; flex-direction: column !important; margin: 0 !important; padding: 0 !important; width: 100% !important; max-width: 100% !important;';
    }
    
    if (footer && body) {
      // Move footer to body if it's inside any container
      if (footer.parentElement !== body) {
        body.appendChild(footer);
      }
      
      // Standard footer styling - full width, at bottom
      footer.style.cssText = 'width: 100% !important; max-width: 100% !important; min-width: 100% !important; margin-left: 0 !important; margin-right: 0 !important; margin-top: auto !important; flex-shrink: 0 !important; padding: 30px 0 !important; border-top: 1px solid var(--line) !important; background: #0c1426 !important; box-sizing: border-box !important; position: relative !important;';
      
      // Fix footer-content - centered with max-width: 980px
      const footerContent = footer.querySelector('.footer-content');
      if (footerContent) {
        footerContent.style.cssText = 'max-width: 980px !important; width: 100% !important; margin-left: auto !important; margin-right: auto !important; padding-left: 20px !important; padding-right: 20px !important; box-sizing: border-box !important; display: grid !important; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important; gap: 30px !important;';
      }
    }
  }
  
  // Run immediately
  fixFooter();
  
  // Run after DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fixFooter);
  }
  
  // Run after load
  window.addEventListener('load', fixFooter);
  
  // Run multiple times to catch late-loading content
  setTimeout(fixFooter, 100);
  setTimeout(fixFooter, 300);
  setTimeout(fixFooter, 500);
})();

// Make changelist filter sidebar static and always visible
(function() {
  function makeSidebarStatic() {
    const filter = document.getElementById('changelist-filter');
    const sticky = document.querySelector('.sticky');
    const stickyContainer = document.querySelector('.sticky-container');
    
    [filter, sticky, stickyContainer].forEach(el => {
      if (el) {
        el.style.cssText = 'position: static !important; display: block !important; visibility: visible !important; opacity: 1 !important; transform: none !important;';
        
        // Hide any collapse/toggle buttons
        const toggleBtns = el.querySelectorAll('.collapse-toggle, .toggle, [class*="toggle"], [class*="collapse"]');
        toggleBtns.forEach(btn => {
          btn.style.display = 'none';
        });
      }
    });
  }
  
  // Run immediately
  makeSidebarStatic();
  
  // Run after DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', makeSidebarStatic);
  }
  
  // Run after load
  window.addEventListener('load', makeSidebarStatic);
  
  // Run multiple times
  setTimeout(makeSidebarStatic, 100);
  setTimeout(makeSidebarStatic, 300);
})();
</script>
{% endblock %}

{% block footer %}
<footer class="footer">
  <div class="footer-content">
    <div class="footer-section">
      <div class="footer-title">PMG Portal</div>
      <div class="footer-text">Version {{ app_version|default:"Unknown" }}</div>
      <div class="footer-text muted">Copyright &copy; {{ copyright_year|default:"2026" }} <a href="https://5echo.io" target="_blank" rel="noopener" class="footer-link">5echo.io</a></div>
      {% if show_changelog_button %}
      <a href="#" class="footer-link" onclick="openChangelogModal(); return false;" style="margin-top: 8px; display: inline-block;">View Changelog</a>
      {% endif %}
    </div>
  </div>
</footer>

{% if show_changelog_button %}
<!-- Changelog Modal -->
<div id="changelogModal" class="modal" onclick="closeChangelogModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2>Changelog - Version {{ app_version|default:"Unknown" }}</h2>
      <button class="modal-close" onclick="closeChangelogModal(event)">&times;</button>
    </div>
    <div class="modal-body">
      {% if changelog_section %}
      <div class="footer-changelog">{{ changelog_section|safe }}</div>
      {% else %}
      <p class="muted">No changelog available for this version.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
function openChangelogModal() {
  const modal = document.getElementById('changelogModal');
  if (modal) {
    modal.style.display = 'flex';
  }
}

function closeChangelogModal(event) {
  if (!event || event.target.id === 'changelogModal' || event.target.classList.contains('modal-close')) {
    const modal = document.getElementById('changelogModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
}

document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('changelogModal');
    if (modal && modal.style.display === 'flex') {
      closeChangelogModal(event);
    }
  }
});
</script>
{% endif %}
{% endblock %}
