{% extends "admin/base.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin_custom.css' %}">
{% endblock %}

{% block usertools %}
<div id="user-tools">
  {% block userlinks %}
  {% if user_customers|length > 1 %}
  <form method="post" action="" id="admin-customer-switcher-form" style="display: inline-block; margin-right: 12px;">
    {% csrf_token %}
    <select name="customer_id" id="admin-customer-switcher" class="admin-customer-switcher" onchange="switchCustomer(this.value)">
      <option value="0" {% if not active_customer_id %}selected{% endif %}>All Customers</option>
      {% for membership in user_customers %}
      <option value="{{ membership.customer.id }}" {% if membership.customer.id == active_customer_id %}selected{% endif %}>
        {{ membership.customer.name }}
      </option>
      {% endfor %}
    </select>
  </form>
  {% endif %}
  <button id="recent-actions-btn" class="admin-icon-btn" title="Recent Actions" onclick="openRecentActionsModal()">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <polyline points="12 6 12 12 16 14"></polyline>
    </svg>
  </button>
  {{ block.super }}
  {% endblock %}
</div>

<script>
  function switchCustomer(customerId) {
    const form = document.getElementById('admin-customer-switcher-form');
    if (form) {
      const customerIdValue = customerId === '' || customerId === '0' ? '0' : customerId;
      form.action = '/portal/switch/' + customerIdValue + '/';
      form.submit();
    }
  }
</script>

<!-- Recent Actions Modal -->
<div id="recent-actions-modal" class="admin-modal" onclick="closeRecentActionsModal(event)">
  <div class="admin-modal-content" onclick="event.stopPropagation()">
    <div class="admin-modal-header">
      <h2>Recent Actions</h2>
      <button class="admin-modal-close" onclick="closeRecentActionsModal(event)">Ã—</button>
    </div>
    <div class="admin-modal-body">
      <div id="recent-actions-list">
        <p class="muted">Loading recent actions...</p>
      </div>
    </div>
  </div>
</div>

<script>
function openRecentActionsModal() {
  const modal = document.getElementById('recent-actions-modal');
  const list = document.getElementById('recent-actions-list');
  
  modal.style.display = 'flex';
  
  // Fetch recent actions via AJAX
  fetch('/admin/log/?limit=15')
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const logEntries = doc.querySelectorAll('#changelist tbody tr');
      
      if (logEntries.length === 0) {
        list.innerHTML = '<p class="muted">No recent actions found.</p>';
        return;
      }
      
      let htmlContent = '<div class="recent-actions-table">';
      logEntries.forEach(entry => {
        const cells = entry.querySelectorAll('td');
        if (cells.length >= 3) {
          htmlContent += `
            <div class="recent-action-item">
              <div class="recent-action-icon">
                ${getActionIcon(cells[1]?.textContent || '')}
              </div>
              <div class="recent-action-content">
                <div class="recent-action-text">${cells[1]?.innerHTML || ''}</div>
                <div class="recent-action-time">${cells[2]?.textContent || ''}</div>
              </div>
            </div>
          `;
        }
      });
      htmlContent += '</div>';
      list.innerHTML = htmlContent;
    })
    .catch(error => {
      list.innerHTML = '<p class="muted">Unable to load recent actions.</p>';
      console.error('Error loading recent actions:', error);
    });
}

function closeRecentActionsModal(event) {
  if (!event || event.target.id === 'recent-actions-modal' || event.target.classList.contains('admin-modal-close')) {
    document.getElementById('recent-actions-modal').style.display = 'none';
  }
}

function getActionIcon(actionText) {
  if (actionText.includes('Added') || actionText.includes('added')) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>';
  } else if (actionText.includes('Changed') || actionText.includes('changed')) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
  } else if (actionText.includes('Deleted') || actionText.includes('deleted')) {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>';
  }
  return '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>';
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeRecentActionsModal();
  }
});
</script>
{% endblock %}
