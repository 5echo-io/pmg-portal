{% extends "portal/base.html" %}
{% block title %}Profile Settings | PMG Portal{% endblock %}

{% block content %}
  <div class="profile-layout">
    <aside class="profile-sidebar">
      <nav class="profile-nav">
        <a href="#account-info" class="profile-nav-item active" onclick="showSection('account-info'); return false;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Account Information
        </a>
        <a href="#change-password" class="profile-nav-item" onclick="showSection('change-password'); openPasswordChangeModal(); return false;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          Change Password
        </a>
        <a href="#delete-account" class="profile-nav-item profile-nav-item-danger" onclick="showSection('delete-account'); openDeleteAccountModal(); return false;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"></path>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
          </svg>
          Delete Account
        </a>
        <div class="profile-nav-divider"></div>
        <a href="/account/logout/" class="profile-nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Logout
        </a>
      </nav>
    </aside>
    
    <main class="profile-content">
      <div id="account-info-section" class="profile-section active">
        <h1>Account Information</h1>
        <div class="panel">
          <div style="margin-top: 16px;">
            <div style="margin-bottom: 12px;">
              <strong>Username:</strong> {{ user.username }}
            </div>
            <div style="margin-bottom: 12px;">
              <strong>Email:</strong> {{ user.email|default:"Not set" }}
            </div>
            <div style="margin-bottom: 12px;">
              <strong>First Name:</strong> {{ user.first_name|default:"Not set" }}
            </div>
            <div style="margin-bottom: 12px;">
              <strong>Last Name:</strong> {{ user.last_name|default:"Not set" }}
            </div>
            <div style="margin-bottom: 12px;">
              <strong>Date Joined:</strong> {{ user.date_joined|date:"F d, Y" }}
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Password Change Modal -->
  <div id="passwordChangeModal" class="modal" {% if show_password_modal %}style="display: flex;"{% else %}style="display: none;"{% endif %} onclick="closePasswordChangeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Change Password</h2>
        <button class="modal-close" onclick="closePasswordChangeModal(event)">&times;</button>
      </div>
      <div class="modal-body">
        <form method="post" id="password-change-form">
          {% csrf_token %}
          <input type="hidden" name="change_password" value="1">
          
          <label>Current Password</label>
          {{ password_form.old_password }}
          {% if password_form.old_password.errors %}
            <div class="alert">{{ password_form.old_password.errors }}</div>
          {% endif %}
          
          <label>New Password</label>
          {{ password_form.new_password1 }}
          {% if password_form.new_password1.errors %}
            <div class="alert">{{ password_form.new_password1.errors }}</div>
          {% endif %}
          {% if password_form.new_password1.help_text %}
            <div class="muted" style="font-size: 12px; margin-top: 4px;">{{ password_form.new_password1.help_text }}</div>
          {% endif %}
          
          <label>Confirm New Password</label>
          {{ password_form.new_password2 }}
          {% if password_form.new_password2.errors %}
            <div class="alert">{{ password_form.new_password2.errors }}</div>
          {% endif %}
          
          {% if password_form.non_field_errors %}
            <div class="alert">{{ password_form.non_field_errors }}</div>
          {% endif %}
          
          <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;">
            <button type="button" onclick="closePasswordChangeModal(event)" class="form-btn form-btn-secondary">Cancel</button>
            <button type="submit" class="form-btn form-btn-primary">Change Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div id="deleteAccountModal" class="modal" style="display: none;" onclick="closeDeleteAccountModal(event)">
    <div class="modal-content modal-content-danger" onclick="event.stopPropagation()">
      <div class="modal-header modal-header-danger">
        <h2>Delete Account</h2>
        <button class="modal-close" onclick="closeDeleteAccountModal(event)">&times;</button>
      </div>
      <div class="modal-body">
        <div class="danger-zone">
          <div class="danger-zone-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
          </div>
          <h3>Warning: This action cannot be undone</h3>
          <p>Deleting your account will permanently remove all your data, including:</p>
          <ul class="danger-list">
            <li>Your user profile and account information</li>
            <li>All customer memberships and access permissions</li>
            <li>All associated data and settings</li>
          </ul>
          <p><strong>This action is irreversible.</strong></p>
          <form method="post" id="delete-account-form" style="margin-top: 24px;">
            {% csrf_token %}
            <input type="hidden" name="delete_account" value="1">
            <label>
              <strong>Type your username to confirm:</strong>
              <input type="text" name="confirm_username" class="form-input" placeholder="{{ user.username }}" required style="margin-top: 8px;">
            </label>
            <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;">
              <button type="button" onclick="closeDeleteAccountModal(event)" class="form-btn form-btn-secondary">Cancel</button>
              <button type="submit" class="form-btn form-btn-danger">Delete My Account</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    function showSection(sectionId) {
      // Update active nav item
      document.querySelectorAll('.profile-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.closest('.profile-nav-item')?.classList.add('active');
    }

    function openPasswordChangeModal() {
      const modal = document.getElementById('passwordChangeModal');
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        const form = document.getElementById('password-change-form');
        if (form) {
          form.reset();
        }
      }
    }
    
    function closePasswordChangeModal(event) {
      if (!event || event.target.classList.contains('modal') || event.target.classList.contains('modal-close') || event.target.textContent === 'Cancel') {
        const modal = document.getElementById('passwordChangeModal');
        if (modal) {
          modal.style.display = 'none';
          document.body.style.overflow = 'auto';
        }
      }
    }

    function openDeleteAccountModal() {
      const modal = document.getElementById('deleteAccountModal');
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        const form = document.getElementById('delete-account-form');
        if (form) {
          form.reset();
        }
      }
    }

    function closeDeleteAccountModal(event) {
      if (!event || event.target.classList.contains('modal') || event.target.classList.contains('modal-close') || event.target.textContent === 'Cancel') {
        const modal = document.getElementById('deleteAccountModal');
        if (modal) {
          modal.style.display = 'none';
          document.body.style.overflow = 'auto';
        }
      }
    }
    
    // Auto-open password modal if there are form errors
    {% if show_password_modal %}
    document.addEventListener('DOMContentLoaded', function() {
      openPasswordChangeModal();
    });
    {% endif %}
    
    // Close modals on Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const passwordModal = document.getElementById('passwordChangeModal');
        const deleteModal = document.getElementById('deleteAccountModal');
        if (passwordModal && passwordModal.style.display === 'flex') {
          closePasswordChangeModal(event);
        }
        if (deleteModal && deleteModal.style.display === 'flex') {
          closeDeleteAccountModal(event);
        }
      }
    });
  </script>
{% endblock %}
