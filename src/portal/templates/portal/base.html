{% load static i18n %}
<!doctype html>
<html lang="{{ current_language_code|default:'en' }}">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}{% trans "PMG Portal" %}{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'app.css' %}">
  <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg7tCRwA0TfVH/t7q6ZcdP2U6Fb2G6FOhDWWktNp4SZM" crossorigin="anonymous"></script>
</head>
<body class="page-wrapper">
  <header class="topbar">
    <div class="topbar-inner">
    <div class="topbar-left">
      <div class="brand">{% trans "PMG Portal" %}</div>
      <div class="topbar-nav">
        <a class="topbar-btn {% if request.path == '/' %}active{% endif %}" href="/" hx-get="/" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">{% trans "Dashboard" %}</a>
        <span class="topbar-btn topbar-btn--disabled topbar-btn--with-tooltip">
          {% trans "Projects" %}
          <span class="tooltip">{% trans "This feature is under development" %}</span>
        </span>
        {% if active_customer_id %}
        <a href="{% url 'facility_list' %}" class="topbar-btn {% if request.resolver_match.url_name == 'facility_list' or request.resolver_match.url_name == 'facility_detail' %}topbar-btn--active{% endif %}" hx-get="{% url 'facility_list' %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">
          {% trans "Facility" %}
        </a>
        {% else %}
        <span class="topbar-btn topbar-btn--disabled topbar-btn--with-tooltip">
          {% trans "Facility" %}
          <span class="tooltip">{% trans "Select a customer profile to access facilities" %}</span>
        </span>
        {% endif %}
        <span class="topbar-btn topbar-btn--disabled topbar-btn--with-tooltip">
          {% trans "Files" %}
          <span class="tooltip">{% trans "This feature is under development" %}</span>
        </span>
      </div>
    </div>
    <div class="topbar-right">
      {% if active_customer_id %}
      <span class="topbar-customer-name">{% for m in user_customers %}{% if m.customer.id == active_customer_id %}{{ m.customer.name }}{% endif %}{% endfor %}</span>
      {% endif %}
      <span class="topbar-btn topbar-btn--disabled topbar-btn--with-tooltip">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        {% trans "Service desk" %}
        <span class="tooltip">{% trans "This feature is under development" %}</span>
      </span>
      <div class="user-avatar-wrapper">
        <button class="user-avatar-btn" onclick="toggleUserMenu(event)" aria-label="User menu">
          <div class="user-avatar">
            {% if request.user.first_name %}{{ request.user.first_name|first|upper }}{% elif request.user.last_name %}{{ request.user.last_name|first|upper }}{% elif request.user.email %}{{ request.user.email|first|upper }}{% else %}{{ request.user.username|first|upper }}{% endif %}
          </div>
        </button>
        <div id="user-menu" class="user-menu">
          <div class="user-menu-header">
            <div class="user-menu-name">{% if request.user.first_name or request.user.last_name %}{{ request.user.first_name }} {{ request.user.last_name }}{% else %}{{ request.user.username }}{% endif %}</div>
            <div class="user-menu-email">{{ request.user.email|default:"" }}</div>
          </div>
          {% if active_customer_id and user_customers|length > 1 %}
          <button type="button" class="user-menu-item user-menu-item--customer-switch" onclick="openCustomerSwitchModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <path d="M21 15l-5-5L5 21"></path>
            </svg>
            {% trans "Switch Customer Profile" %}
          </button>
          {% endif %}
          <div class="user-menu-divider"></div>
        <a href="/account/profile/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          {% trans "Profile Settings" %}
        </a>
        {% if request.user.is_superuser %}
        <div class="user-menu-divider"></div>
        <a href="/debug/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          {% trans "Debug" %}
        </a>
        {% endif %}
        <div class="user-menu-divider"></div>
        <a href="/account/logout/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          {% trans "Logout" %}
        </a>
        </div>
      </div>
    </div>
    </div>
  </header>
  
  <script>
    function selectCustomer(customerId) {
      const form = document.getElementById('customer-switcher-form');
      const id = typeof customerId === 'string' ? customerId : String(customerId);
      if (form && id) {
        form.action = '/switch/' + id + '/';
        form.submit();
      }
    }

    function toggleCustomerMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('customer-menu');
      if (!menu) return;
      const isOpen = menu.classList.contains('open');
      document.querySelectorAll('.customer-menu').forEach(function(m) { m.classList.remove('open'); });
      document.querySelectorAll('.user-menu').forEach(function(m) { m.classList.remove('open'); });
      if (!isOpen) {
        menu.classList.add('open');
        var searchInput = document.getElementById('customer-search');
        if (searchInput) { searchInput.value = ''; filterCustomerMenu(''); }
        setTimeout(function() {
          var closeHandler = function(e) {
            if (!menu.contains(e.target) && !e.target.closest('.customer-picker-btn')) {
              menu.classList.remove('open');
              document.removeEventListener('click', closeHandler);
            }
          };
          document.addEventListener('click', closeHandler, { once: true });
        }, 10);
      }
    }

    function filterCustomerMenu(q) {
      q = (q || '').toLowerCase().trim();
      document.querySelectorAll('#customer-menu .customer-menu-item').forEach(function(item) {
        var name = (item.getAttribute('data-customer-name') || item.textContent || '').toLowerCase();
        item.style.display = q === '' || name.indexOf(q) !== -1 ? '' : 'none';
      });
    }

    function toggleUserMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('user-menu');
      if (!menu) return;
      
      const isOpen = menu.classList.contains('open');
      
      // Close all menus (user and customer)
      document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
      document.querySelectorAll('.customer-menu').forEach(m => m.classList.remove('open'));
      
      if (!isOpen) {
        menu.classList.add('open');
        // Close on outside click
        setTimeout(() => {
          const closeHandler = function(e) {
            if (!menu.contains(e.target) && !e.target.closest('.user-avatar-btn')) {
              menu.classList.remove('open');
              document.removeEventListener('click', closeHandler);
            }
          };
          document.addEventListener('click', closeHandler, { once: true });
        }, 10);
      }
    }
    
    // Language submenu: open on click, close on mouse leave
    (function() {
      var wrap = document.getElementById('user-menu-lang-wrap');
      var trigger = document.getElementById('user-menu-lang-trigger');
      var sub = document.getElementById('user-menu-lang-submenu');
      if (!wrap || !trigger || !sub) return;
      trigger.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        wrap.classList.toggle('user-menu-submenu-open');
        trigger.setAttribute('aria-expanded', wrap.classList.contains('user-menu-submenu-open'));
      });
      wrap.addEventListener('mouseleave', function() {
        wrap.classList.remove('user-menu-submenu-open');
        trigger.setAttribute('aria-expanded', 'false');
      });
    })();

    // Close menu on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
        document.querySelectorAll('.user-menu-item-wrapper--lang').forEach(w => w.classList.remove('user-menu-submenu-open'));
        document.querySelectorAll('.customer-menu').forEach(m => m.classList.remove('open'));
      }
    });

    // HTMX: update document title when main content is swapped
    document.body.addEventListener('setTitle', function(e) {
      if (e.detail && e.detail.title) document.title = e.detail.title;
    });

    // Customer switch modal
    function openCustomerSwitchModal() {
      const modal = document.getElementById('customer-switch-modal');
      if (!modal) return;
      modal.classList.add('modal-open');
      document.body.style.overflow = 'hidden';
      const searchInput = modal.querySelector('#customer-switch-search');
      if (searchInput) {
        setTimeout(() => searchInput.focus(), 100);
      }
    }

    function closeCustomerSwitchModal() {
      const modal = document.getElementById('customer-switch-modal');
      if (modal) {
        modal.classList.remove('modal-open');
        document.body.style.overflow = '';
      }
    }

    function filterCustomerSwitchModal(q) {
      q = (q || '').toLowerCase().trim();
      document.querySelectorAll('#customer-switch-modal .customer-switch-card').forEach(function(card) {
        const name = (card.getAttribute('data-customer-name') || card.textContent || '').toLowerCase();
        card.style.display = q === '' || name.indexOf(q) !== -1 ? '' : 'none';
      });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeCustomerSwitchModal();
      }
    });

    // Close modal when clicking backdrop
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('customer-switch-modal');
      if (modal && e.target === modal) {
        closeCustomerSwitchModal();
      }
    });

    // Handle customer switch card clicks
    document.addEventListener('click', function(e) {
      const card = e.target.closest('[data-customer-switch="true"]');
      if (card) {
        const customerId = card.getAttribute('data-customer-id');
        if (customerId) {
          selectCustomer(customerId);
          closeCustomerSwitchModal();
        }
      }
    });
  </script>

  <!-- Customer Switch Modal -->
  {% if active_customer_id and user_customers|length > 1 %}
  <div id="customer-switch-modal" class="customer-switch-modal">
    <div class="customer-switch-modal-content">
      <div class="customer-switch-modal-header">
        <h2>{% trans "Switch Customer Profile" %}</h2>
        <button type="button" class="customer-switch-modal-close" onclick="closeCustomerSwitchModal()" aria-label="{% trans 'Close' %}">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      {% if user_customers|length > 4 %}
      <div class="customer-switch-modal-search">
        <input type="text" class="customer-switch-modal-search-input" id="customer-switch-search" placeholder="{% trans 'Search customers…' %}" oninput="filterCustomerSwitchModal(this.value)" aria-label="{% trans 'Search customers' %}">
      </div>
      {% endif %}
      <div class="customer-switch-modal-list">
        {% for membership in user_customers %}
        <div class="customer-switch-card {% if membership.customer.id == active_customer_id %}customer-switch-card--active{% endif %}" data-customer-id="{{ membership.customer.id }}" data-customer-name="{{ membership.customer.name|escape }}" {% if membership.customer.id != active_customer_id %}data-customer-switch="true"{% endif %}>
          {% if membership.customer.logo_url %}
          <div class="customer-switch-card-logo">
            <img src="{{ membership.customer.logo_url }}" alt="{{ membership.customer.name }} logo" onerror="this.style.display='none';" />
          </div>
          {% else %}
          <div class="customer-switch-card-logo customer-switch-card-logo--placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <path d="M21 15l-5-5L5 21"></path>
            </svg>
          </div>
          {% endif %}
          <div class="customer-switch-card-content">
            <div class="customer-switch-card-name">{{ membership.customer.name }}</div>
            {% if membership.customer.org_number %}
            <div class="customer-switch-card-org muted">{% trans "Org. no." %}: {{ membership.customer.org_number }}</div>
            {% endif %}
          </div>
          {% if membership.customer.id == active_customer_id %}
          <div class="customer-switch-card-check">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>
          {% else %}
          <div class="customer-switch-card-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <form method="post" action="" id="customer-switcher-form" style="display: none;">
    {% csrf_token %}
  </form>
  {% endif %}

  <main class="main-content">
    <div class="container">
      <div id="main-content">
      {% if messages %}
      <div class="toast-container">
        {% for message in messages %}
        <div class="toast toast-{{ message.tags }}" data-toast-id="{{ forloop.counter }}">
          <div class="toast-content">
            <span class="toast-message">{{ message }}</span>
            <button class="toast-close" onclick="dismissToast(this.parentElement.parentElement)">×</button>
          </div>
        </div>
        {% endfor %}
      </div>
      <script>
        // Auto-dismiss toasts after 5 seconds
        document.querySelectorAll('.toast').forEach(function(toast) {
          setTimeout(function() {
            dismissToast(toast);
          }, 5000);
        });
        
        function dismissToast(toast) {
          if (toast) {
            toast.style.animation = 'toastSlideOut 0.3s ease-out';
            setTimeout(function() {
              toast.remove();
            }, 300);
          }
        }
      </script>
      {% endif %}
      {% block content %}{% endblock %}
      </div>
    </div>
  </main>

  <div class="site-footer-wrapper">
    <footer class="footer">
      {% include "includes/site_footer.html" %}
    </footer>
  </div>

  <!-- Changelog Modal -->
  {% if show_changelog_button %}
  <div id="changelogModal" class="modal" data-changelog-view="short" onclick="closeChangelogModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>{% trans "Changelog" %} - {% trans "Version" %} {{ app_version|default:"Unknown" }}</h2>
        <button class="modal-close" onclick="closeChangelogModal(event)">&times;</button>
      </div>
      <div class="modal-body">
        <div id="shortChangelogWrap" class="changelog-section-wrap">
        {% if changelog_section %}
        <div class="changelog-section">
          <pre class="changelog-content">{{ changelog_section|escape }}</pre>
        </div>
        {% endif %}
        </div>
        {% if changelog_full %}
        <div class="modal-actions">
          <button class="modal-btn" id="toggleFullChangelogBtn" onclick="toggleFullChangelog()" data-text-view="{% trans 'View Full Changelog' %}" data-text-hide="{% trans 'Hide Full Changelog' %}">{% trans "View Full Changelog" %}</button>
        </div>
        <div id="fullChangelog" class="changelog-section full-changelog-section" style="display: none; opacity: 0;">
          <pre class="changelog-content">{{ changelog_full|escape }}</pre>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- About Modal -->
  <div id="aboutModal" class="modal" onclick="closeAboutModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>{% trans "About this portal" %} - {% trans "PMG Portal" %}</h2>
        <button class="modal-close" onclick="closeAboutModal(event)">&times;</button>
      </div>
      <div class="modal-body">
        <div class="about-section">
          <h3>{% trans "PMG Portal" %}</h3>
          <p class="about-version">
            <strong>{% trans "Version" %}:</strong> {{ app_version|default:"Unknown" }}
            {% if has_update_available %}
            <span class="about-update-indicator" title="{% trans 'Update available' %}">● {% trans "Update available" %}</span>
            {% endif %}
          </p>
        </div>
        
        <div class="about-section">
          <h3>{% trans "Developed by" %}</h3>
          <p>
            <a href="https://5echo.io" target="_blank" rel="noopener" class="about-link">5echo.io</a>
          </p>
          <p class="about-muted">
            {% trans "PMG Portal is developed and maintained by 5echo.io" %}
          </p>
          <p class="about-muted">
            <strong>{% trans "Head developer" %}:</strong> Kevin Jung Park
          </p>
        </div>

        {% if request.user.is_superuser %}
        <div class="about-section about-admin-section">
          <h3>{% trans "Updates" %}</h3>
          {% csrf_token %}
          <button type="button" class="form-btn form-btn-primary" id="check-updates-btn" onclick="checkForUpdates()" data-text-check="{% trans 'Check for updates' %}" data-text-checking="{% trans 'Checking...' %}">
            {% trans "Check for updates" %}
          </button>
          <div id="update-status" class="update-status" style="display: none;" data-text-checking="{% trans 'Checking for updates...' %}" data-text-latest="{% trans 'You are running the latest version.' %}" data-text-error="{% trans 'Could not check for updates. Please try again later.' %}" data-text-update="{% trans 'Update available' %}"></div>
        </div>
        {% endif %}

        <div class="about-section">
          <p class="about-muted">
            &copy; {{ copyright_year|default:"2026" }} <a href="https://5echo.io" target="_blank" rel="noopener" class="about-link">5echo.io</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Make functions globally available
    window.openChangelogModal = function() {
      document.getElementById('changelogModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    };
    
    window.closeChangelogModal = function(event) {
      if (!event || event.target.classList.contains('modal') || event.target.classList.contains('modal-close')) {
        const modal = document.getElementById('changelogModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        modal.setAttribute('data-changelog-view', 'short');
        const fullChangelog = document.getElementById('fullChangelog');
        const shortWrap = document.getElementById('shortChangelogWrap');
        const btn = document.getElementById('toggleFullChangelogBtn');
        if (fullChangelog) { fullChangelog.style.display = 'none'; fullChangelog.classList.remove('changelog-fade-in', 'changelog-fade-out'); fullChangelog.style.opacity = ''; }
        if (shortWrap) { shortWrap.style.display = ''; shortWrap.classList.remove('changelog-fade-in', 'changelog-fade-out'); shortWrap.style.opacity = ''; }
        if (btn) btn.textContent = 'View Full Changelog';
      }
    };

    window.toggleFullChangelog = function() {
      const modal = document.getElementById('changelogModal');
      const fullChangelog = document.getElementById('fullChangelog');
      const shortWrap = document.getElementById('shortChangelogWrap');
      const btn = document.getElementById('toggleFullChangelogBtn');
      if (!modal || !fullChangelog || !shortWrap || !btn) return;
      btn.classList.add('changelog-btn-animate');
      setTimeout(function() { btn.classList.remove('changelog-btn-animate'); }, 400);
      var showingFull = modal.getAttribute('data-changelog-view') === 'full';
      var duration = 220;
      if (showingFull) {
        fullChangelog.classList.add('changelog-fade-out');
        setTimeout(function() {
          fullChangelog.style.display = 'none';
          fullChangelog.classList.remove('changelog-fade-out');
          shortWrap.style.display = '';
          shortWrap.style.opacity = '0';
          shortWrap.offsetHeight;
          shortWrap.classList.add('changelog-fade-in');
          shortWrap.style.opacity = '1';
          btn.textContent = (btn.getAttribute && btn.getAttribute('data-text-view')) || 'View Full Changelog';
          modal.setAttribute('data-changelog-view', 'short');
        }, duration);
      } else {
        shortWrap.classList.add('changelog-fade-out');
        setTimeout(function() {
          shortWrap.style.display = 'none';
          shortWrap.classList.remove('changelog-fade-out');
          fullChangelog.style.display = 'block';
          fullChangelog.style.opacity = '0';
          fullChangelog.offsetHeight;
          fullChangelog.classList.add('changelog-fade-in');
          fullChangelog.style.opacity = '1';
          btn.textContent = (btn.getAttribute && btn.getAttribute('data-text-hide')) || 'Hide Full Changelog';
          modal.setAttribute('data-changelog-view', 'full');
        }, duration);
      }
    }
    
    function openAboutModal() {
      document.getElementById('aboutModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    
    function closeAboutModal(event) {
      if (!event || event.target.classList.contains('modal') || event.target.classList.contains('modal-close')) {
        const modal = document.getElementById('aboutModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }
    
    function checkForUpdates() {
      const btn = document.getElementById('check-updates-btn');
      const status = document.getElementById('update-status');
      if (!btn || !status) return;
      
      const textCheck = btn.getAttribute('data-text-check') || 'Check for updates';
      const textChecking = btn.getAttribute('data-text-checking') || 'Checking...';
      const textCheckingStatus = status.getAttribute('data-text-checking') || 'Checking for updates...';
      const textLatest = status.getAttribute('data-text-latest') || 'You are running the latest version.';
      const textError = status.getAttribute('data-text-error') || 'Could not check for updates. Please try again later.';
      const textUpdate = status.getAttribute('data-text-update') || 'Update available';
      
      btn.disabled = true;
      btn.textContent = textChecking;
      status.style.display = 'block';
      status.innerHTML = '<p class="muted">' + textCheckingStatus + '</p>';
      
      fetch('/about/check-updates/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        btn.disabled = false;
        btn.textContent = textCheck;
        if (data.has_update) {
          status.innerHTML = '<p style="color: #22c55e;"><strong>' + textUpdate + ':</strong> ' + (data.latest_version || 'Unknown') + '</p>';
        } else {
          status.innerHTML = '<p style="color: var(--muted);">' + textLatest + '</p>';
        }
      })
      .catch(error => {
        btn.disabled = false;
        btn.textContent = textCheck;
        status.innerHTML = '<p style="color: var(--error);">' + textError + '</p>';
      });
    }
    
    // Close on ESC key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const changelogModal = document.getElementById('changelogModal');
        const aboutModal = document.getElementById('aboutModal');
        if (changelogModal && changelogModal.style.display === 'flex') {
          closeChangelogModal(event);
        }
        if (aboutModal && aboutModal.style.display === 'flex') {
          closeAboutModal(event);
        }
        document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
      }
    });
    
    // Make toggleUserMenu globally accessible
    window.toggleUserMenu = toggleUserMenu;
    
    // Frontend logging for debug view
    (function() {
      window.pmgDebugLogs = window.pmgDebugLogs || [];
      const MAX_LOGS = 100;
      
      function logEvent(type, data) {
        const logEntry = {
          timestamp: new Date().toISOString(),
          type: type,
          data: data,
          url: window.location.pathname,
          userAgent: navigator.userAgent,
        };
        window.pmgDebugLogs.push(logEntry);
        if (window.pmgDebugLogs.length > MAX_LOGS) {
          window.pmgDebugLogs.shift();
        }
        console.debug('[PMG Debug]', type, data);
      }
      
      // Log button clicks
      document.addEventListener('click', function(e) {
        const target = e.target;
        if (target.tagName === 'BUTTON' || target.tagName === 'A' || target.closest('button') || target.closest('a')) {
          const element = target.closest('button') || target.closest('a') || target;
          logEvent('click', {
            element: element.tagName,
            id: element.id || null,
            className: element.className || null,
            text: element.textContent?.trim().substring(0, 50) || null,
            href: element.href || null,
          });
        }
      });
      
      // Log form submissions
      document.addEventListener('submit', function(e) {
        logEvent('form_submit', {
          formId: e.target.id || null,
          action: e.target.action || null,
          method: e.target.method || 'GET',
        });
      });
      
      // Log page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          logEvent('page_load', {
            readyState: document.readyState,
            loadTime: performance.timing ? performance.timing.loadEventEnd - performance.timing.navigationStart : null,
          });
        });
      } else {
        logEvent('page_load', {
          readyState: document.readyState,
          loadTime: performance.timing ? performance.timing.loadEventEnd - performance.timing.navigationStart : null,
        });
      }
      
      // Log JavaScript errors
      window.addEventListener('error', function(e) {
        logEvent('javascript_error', {
          message: e.message,
          filename: e.filename,
          lineno: e.lineno,
          colno: e.colno,
          error: e.error ? e.error.toString() : null,
        });
      });
      
      // Log unhandled promise rejections
      window.addEventListener('unhandledrejection', function(e) {
        logEvent('promise_rejection', {
          reason: e.reason ? e.reason.toString() : 'Unknown',
        });
      });

      // Log fetch requests
      if (window.fetch && !window.__pmgFetchWrapped) {
        const originalFetch = window.fetch;
        window.fetch = function(input, init) {
          const url = typeof input === 'string' ? input : input.url;
          const method = (init && init.method) || 'GET';
          logEvent('fetch_start', { url: url, method: method });
          return originalFetch.apply(this, arguments)
            .then(function(response) {
              logEvent('fetch_end', { url: url, method: method, status: response.status });
              return response;
            })
            .catch(function(error) {
              logEvent('fetch_error', { url: url, method: method, error: error ? error.toString() : 'Unknown' });
              throw error;
            });
        };
        window.__pmgFetchWrapped = true;
      }

      // Log XHR requests
      if (window.XMLHttpRequest && !window.__pmgXhrWrapped) {
        const originalOpen = XMLHttpRequest.prototype.open;
        const originalSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.open = function(method, url) {
          this.__pmgMethod = method;
          this.__pmgUrl = url;
          return originalOpen.apply(this, arguments);
        };
        XMLHttpRequest.prototype.send = function() {
          const xhr = this;
          logEvent('xhr_start', { url: xhr.__pmgUrl, method: xhr.__pmgMethod });
          xhr.addEventListener('load', function() {
            logEvent('xhr_end', { url: xhr.__pmgUrl, method: xhr.__pmgMethod, status: xhr.status });
          });
          xhr.addEventListener('error', function() {
            logEvent('xhr_error', { url: xhr.__pmgUrl, method: xhr.__pmgMethod, status: xhr.status });
          });
          return originalSend.apply(this, arguments);
        };
        window.__pmgXhrWrapped = true;
      }
      
      // Make logs accessible globally
      window.getPmgDebugLogs = function() {
        return window.pmgDebugLogs;
      };
    })();
  </script>
</body>
</html>
