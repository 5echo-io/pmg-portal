{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}PMG Portal{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'app.css' %}">
  <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg7tCRwA0TfVH/t7q6ZcdP2U6Fb2G6FOhDWWktNp4SZM" crossorigin="anonymous"></script>
</head>
<body class="page-wrapper">
  <header class="topbar">
    <div class="topbar-inner">
    <div class="topbar-left">
      <div class="brand">PMG Portal</div>
      <div class="topbar-nav">
        <a class="topbar-btn {% if request.path == '/' %}active{% endif %}" href="/" hx-get="/" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">Portal</a>
        <span class="topbar-btn topbar-btn--disabled" title="This feature is under development">Facility</span>
      </div>
    </div>
    <div class="topbar-right">
      {% if user_customers|length > 1 %}
      <div class="customer-picker-wrapper">
        <button type="button" class="customer-picker-btn" onclick="toggleCustomerMenu(event)" aria-label="Select customer" id="customer-picker-btn">
          <span class="customer-picker-label">{% for m in user_customers %}{% if m.customer.id == active_customer_id %}{{ m.customer.name }}{% endif %}{% endfor %}</span>
          <svg class="customer-picker-chevron" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
        </button>
        <div id="customer-menu" class="customer-menu">
          {% if user_customers|length > 4 %}
          <div class="customer-menu-search">
            <input type="text" class="customer-menu-search-input" placeholder="Search customers…" id="customer-search" oninput="filterCustomerMenu(this.value)" aria-label="Search customers">
          </div>
          {% endif %}
          <div class="customer-menu-list">
            {% for membership in user_customers %}
            <button type="button" class="customer-menu-item {% if membership.customer.id == active_customer_id %}customer-menu-item--active{% endif %}" data-customer-id="{{ membership.customer.id }}" data-customer-name="{{ membership.customer.name }}" onclick="selectCustomer({{ membership.customer.id }})">
              <span class="customer-menu-item-text">{{ membership.customer.name }}</span>
              {% if membership.customer.id == active_customer_id %}
              <svg class="customer-menu-item-check" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>
              {% endif %}
            </button>
            {% endfor %}
          </div>
        </div>
      </div>
      <form method="post" action="" id="customer-switcher-form" style="display: none;">
        {% csrf_token %}
      </form>
      {% elif user_customers|length == 1 %}
      <span class="topbar-customer-name">{{ user_customers.0.customer.name }}</span>
      {% endif %}
      <div class="user-avatar-wrapper">
        <button class="user-avatar-btn" onclick="toggleUserMenu(event)" aria-label="User menu">
          <div class="user-avatar">
            {% if request.user.first_name %}{{ request.user.first_name|first|upper }}{% elif request.user.last_name %}{{ request.user.last_name|first|upper }}{% elif request.user.email %}{{ request.user.email|first|upper }}{% else %}{{ request.user.username|first|upper }}{% endif %}
          </div>
        </button>
        <div id="user-menu" class="user-menu">
          <div class="user-menu-header">
            <div class="user-menu-name">{% if request.user.first_name or request.user.last_name %}{{ request.user.first_name }} {{ request.user.last_name }}{% else %}{{ request.user.username }}{% endif %}</div>
            <div class="user-menu-email">{{ request.user.email|default:"" }}</div>
          </div>
        <div class="user-menu-divider"></div>
        <a href="/account/profile/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Profile Settings
        </a>
        <div class="user-menu-item-wrapper user-menu-item-wrapper--lang">
          <div class="user-menu-item user-menu-item--lang-trigger">
            <span class="user-menu-lang-flag" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="14" viewBox="0 0 60 30" fill="none"><rect width="60" height="30" fill="#012169"/><path d="M0 0l60 30M60 0L0 30" stroke="#fff" stroke-width="6"/><path d="M0 0l60 30M60 0L0 30" stroke="#C8102E" stroke-width="4"/><path d="M30 0v30M0 15h60" stroke="#fff" stroke-width="10"/><path d="M30 0v30M0 15h60" stroke="#C8102E" stroke-width="6"/></svg>
            </span>
            English
          </div>
          <div class="user-menu-submenu">
            <button type="button" class="user-menu-item user-menu-submenu-item">
              <span class="user-menu-lang-flag" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="14" viewBox="0 0 60 30" fill="none"><rect width="60" height="30" fill="#012169"/><path d="M0 0l60 30M60 0L0 30" stroke="#fff" stroke-width="6"/><path d="M0 0l60 30M60 0L0 30" stroke="#C8102E" stroke-width="4"/><path d="M30 0v30M0 15h60" stroke="#fff" stroke-width="10"/><path d="M30 0v30M0 15h60" stroke="#C8102E" stroke-width="6"/></svg>
              </span>
              English
            </button>
          </div>
        </div>
        {% if request.user.is_superuser %}
        <div class="user-menu-divider"></div>
        <a href="/admin/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          Admin Panel
        </a>
        <a href="/debug/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          Debug
        </a>
        {% endif %}
        <div class="user-menu-divider"></div>
        <a href="/account/logout/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Logout
        </a>
        </div>
      </div>
    </div>
    </div>
  </header>
  
  <script>
    function selectCustomer(customerId) {
      const form = document.getElementById('customer-switcher-form');
      if (form && customerId) {
        form.action = '/switch/' + customerId + '/';
        form.submit();
      }
    }

    function toggleCustomerMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('customer-menu');
      if (!menu) return;
      const isOpen = menu.classList.contains('open');
      document.querySelectorAll('.customer-menu').forEach(function(m) { m.classList.remove('open'); });
      document.querySelectorAll('.user-menu').forEach(function(m) { m.classList.remove('open'); });
      if (!isOpen) {
        menu.classList.add('open');
        var searchInput = document.getElementById('customer-search');
        if (searchInput) { searchInput.value = ''; filterCustomerMenu(''); }
        setTimeout(function() {
          var closeHandler = function(e) {
            if (!menu.contains(e.target) && !e.target.closest('.customer-picker-btn')) {
              menu.classList.remove('open');
              document.removeEventListener('click', closeHandler);
            }
          };
          document.addEventListener('click', closeHandler, { once: true });
        }, 10);
      }
    }

    function filterCustomerMenu(q) {
      q = (q || '').toLowerCase().trim();
      document.querySelectorAll('#customer-menu .customer-menu-item').forEach(function(item) {
        var name = (item.getAttribute('data-customer-name') || item.textContent || '').toLowerCase();
        item.style.display = q === '' || name.indexOf(q) !== -1 ? '' : 'none';
      });
    }

    function toggleUserMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('user-menu');
      if (!menu) return;
      
      const isOpen = menu.classList.contains('open');
      
      // Close all menus (user and customer)
      document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
      document.querySelectorAll('.customer-menu').forEach(m => m.classList.remove('open'));
      
      if (!isOpen) {
        menu.classList.add('open');
        // Close on outside click
        setTimeout(() => {
          const closeHandler = function(e) {
            if (!menu.contains(e.target) && !e.target.closest('.user-avatar-btn')) {
              menu.classList.remove('open');
              document.removeEventListener('click', closeHandler);
            }
          };
          document.addEventListener('click', closeHandler, { once: true });
        }, 10);
      }
    }
    
    // Close menu on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
        document.querySelectorAll('.customer-menu').forEach(m => m.classList.remove('open'));
      }
    });

    // HTMX: update document title when main content is swapped
    document.body.addEventListener('setTitle', function(e) {
      if (e.detail && e.detail.title) document.title = e.detail.title;
    });
  </script>

  <main class="main-content">
    <div class="container">
      <div id="main-content">
      {% if messages %}
      <div class="toast-container">
        {% for message in messages %}
        <div class="toast toast-{{ message.tags }}" data-toast-id="{{ forloop.counter }}">
          <div class="toast-content">
            <span class="toast-message">{{ message }}</span>
            <button class="toast-close" onclick="dismissToast(this.parentElement.parentElement)">×</button>
          </div>
        </div>
        {% endfor %}
      </div>
      <script>
        // Auto-dismiss toasts after 5 seconds
        document.querySelectorAll('.toast').forEach(function(toast) {
          setTimeout(function() {
            dismissToast(toast);
          }, 5000);
        });
        
        function dismissToast(toast) {
          if (toast) {
            toast.style.animation = 'toastSlideOut 0.3s ease-out';
            setTimeout(function() {
              toast.remove();
            }, 300);
          }
        }
      </script>
      {% endif %}
      {% block content %}{% endblock %}
      </div>
    </div>
  </main>

  <div class="site-footer-wrapper">
    <footer class="footer">
      {% include "includes/site_footer.html" %}
    </footer>
  </div>

  <!-- Changelog Modal -->
  {% if show_changelog_button %}
  <div id="changelogModal" class="modal" data-changelog-view="short" onclick="closeChangelogModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Changelog - Version {{ app_version|default:"Unknown" }}</h2>
        <button class="modal-close" onclick="closeChangelogModal(event)">&times;</button>
      </div>
      <div class="modal-body">
        <div id="shortChangelogWrap" class="changelog-section-wrap">
        {% if changelog_section %}
        <div class="changelog-section">
          <pre class="changelog-content">{{ changelog_section|escape }}</pre>
        </div>
        {% endif %}
        </div>
        {% if changelog_full %}
        <div class="modal-actions">
          <button class="modal-btn" id="toggleFullChangelogBtn" onclick="toggleFullChangelog()">View Full Changelog</button>
        </div>
        <div id="fullChangelog" class="changelog-section full-changelog-section" style="display: none; opacity: 0;">
          <pre class="changelog-content">{{ changelog_full|escape }}</pre>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <script>
    function openChangelogModal() {
      document.getElementById('changelogModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    
    function closeChangelogModal(event) {
      if (!event || event.target.classList.contains('modal') || event.target.classList.contains('modal-close')) {
        const modal = document.getElementById('changelogModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
        modal.setAttribute('data-changelog-view', 'short');
        const fullChangelog = document.getElementById('fullChangelog');
        const shortWrap = document.getElementById('shortChangelogWrap');
        const btn = document.getElementById('toggleFullChangelogBtn');
        if (fullChangelog) { fullChangelog.style.display = 'none'; fullChangelog.classList.remove('changelog-fade-in', 'changelog-fade-out'); fullChangelog.style.opacity = ''; }
        if (shortWrap) { shortWrap.style.display = ''; shortWrap.classList.remove('changelog-fade-in', 'changelog-fade-out'); shortWrap.style.opacity = ''; }
        if (btn) btn.textContent = 'View Full Changelog';
      }
    }

    function toggleFullChangelog() {
      const modal = document.getElementById('changelogModal');
      const fullChangelog = document.getElementById('fullChangelog');
      const shortWrap = document.getElementById('shortChangelogWrap');
      const btn = document.getElementById('toggleFullChangelogBtn');
      if (!modal || !fullChangelog || !shortWrap || !btn) return;
      btn.classList.add('changelog-btn-animate');
      setTimeout(function() { btn.classList.remove('changelog-btn-animate'); }, 400);
      var showingFull = modal.getAttribute('data-changelog-view') === 'full';
      var duration = 220;
      if (showingFull) {
        fullChangelog.classList.add('changelog-fade-out');
        setTimeout(function() {
          fullChangelog.style.display = 'none';
          fullChangelog.classList.remove('changelog-fade-out');
          shortWrap.style.display = '';
          shortWrap.style.opacity = '0';
          shortWrap.offsetHeight;
          shortWrap.classList.add('changelog-fade-in');
          shortWrap.style.opacity = '1';
          btn.textContent = 'View Full Changelog';
          modal.setAttribute('data-changelog-view', 'short');
        }, duration);
      } else {
        shortWrap.classList.add('changelog-fade-out');
        setTimeout(function() {
          shortWrap.style.display = 'none';
          shortWrap.classList.remove('changelog-fade-out');
          fullChangelog.style.display = 'block';
          fullChangelog.style.opacity = '0';
          fullChangelog.offsetHeight;
          fullChangelog.classList.add('changelog-fade-in');
          fullChangelog.style.opacity = '1';
          btn.textContent = 'Hide Full Changelog';
          modal.setAttribute('data-changelog-view', 'full');
        }, duration);
      }
    }
    
    // Close on ESC key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('changelogModal');
        if (modal && modal.style.display === 'flex') {
          closeChangelogModal(event);
        }
        document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
      }
    });
    
    // Make toggleUserMenu globally accessible
    window.toggleUserMenu = toggleUserMenu;
    
    // Frontend logging for debug view
    (function() {
      window.pmgDebugLogs = window.pmgDebugLogs || [];
      const MAX_LOGS = 100;
      
      function logEvent(type, data) {
        const logEntry = {
          timestamp: new Date().toISOString(),
          type: type,
          data: data,
          url: window.location.pathname,
          userAgent: navigator.userAgent,
        };
        window.pmgDebugLogs.push(logEntry);
        if (window.pmgDebugLogs.length > MAX_LOGS) {
          window.pmgDebugLogs.shift();
        }
        console.debug('[PMG Debug]', type, data);
      }
      
      // Log button clicks
      document.addEventListener('click', function(e) {
        const target = e.target;
        if (target.tagName === 'BUTTON' || target.tagName === 'A' || target.closest('button') || target.closest('a')) {
          const element = target.closest('button') || target.closest('a') || target;
          logEvent('click', {
            element: element.tagName,
            id: element.id || null,
            className: element.className || null,
            text: element.textContent?.trim().substring(0, 50) || null,
            href: element.href || null,
          });
        }
      });
      
      // Log form submissions
      document.addEventListener('submit', function(e) {
        logEvent('form_submit', {
          formId: e.target.id || null,
          action: e.target.action || null,
          method: e.target.method || 'GET',
        });
      });
      
      // Log page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          logEvent('page_load', {
            readyState: document.readyState,
            loadTime: performance.timing ? performance.timing.loadEventEnd - performance.timing.navigationStart : null,
          });
        });
      } else {
        logEvent('page_load', {
          readyState: document.readyState,
          loadTime: performance.timing ? performance.timing.loadEventEnd - performance.timing.navigationStart : null,
        });
      }
      
      // Log JavaScript errors
      window.addEventListener('error', function(e) {
        logEvent('javascript_error', {
          message: e.message,
          filename: e.filename,
          lineno: e.lineno,
          colno: e.colno,
          error: e.error ? e.error.toString() : null,
        });
      });
      
      // Log unhandled promise rejections
      window.addEventListener('unhandledrejection', function(e) {
        logEvent('promise_rejection', {
          reason: e.reason ? e.reason.toString() : 'Unknown',
        });
      });

      // Log fetch requests
      if (window.fetch && !window.__pmgFetchWrapped) {
        const originalFetch = window.fetch;
        window.fetch = function(input, init) {
          const url = typeof input === 'string' ? input : input.url;
          const method = (init && init.method) || 'GET';
          logEvent('fetch_start', { url: url, method: method });
          return originalFetch.apply(this, arguments)
            .then(function(response) {
              logEvent('fetch_end', { url: url, method: method, status: response.status });
              return response;
            })
            .catch(function(error) {
              logEvent('fetch_error', { url: url, method: method, error: error ? error.toString() : 'Unknown' });
              throw error;
            });
        };
        window.__pmgFetchWrapped = true;
      }

      // Log XHR requests
      if (window.XMLHttpRequest && !window.__pmgXhrWrapped) {
        const originalOpen = XMLHttpRequest.prototype.open;
        const originalSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.open = function(method, url) {
          this.__pmgMethod = method;
          this.__pmgUrl = url;
          return originalOpen.apply(this, arguments);
        };
        XMLHttpRequest.prototype.send = function() {
          const xhr = this;
          logEvent('xhr_start', { url: xhr.__pmgUrl, method: xhr.__pmgMethod });
          xhr.addEventListener('load', function() {
            logEvent('xhr_end', { url: xhr.__pmgUrl, method: xhr.__pmgMethod, status: xhr.status });
          });
          xhr.addEventListener('error', function() {
            logEvent('xhr_error', { url: xhr.__pmgUrl, method: xhr.__pmgMethod, status: xhr.status });
          });
          return originalSend.apply(this, arguments);
        };
        window.__pmgXhrWrapped = true;
      }
      
      // Make logs accessible globally
      window.getPmgDebugLogs = function() {
        return window.pmgDebugLogs;
      };
    })();
  </script>
</body>
</html>
