{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}PMG Portal{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'app.css' %}">
</head>
<body>
  <header class="topbar">
    <div class="brand">PMG Portal</div>
    <div class="topbar-right">
      {% if user_customers|length > 1 %}
      <form method="post" action="" id="customer-switcher-form" style="display: inline-block; margin-right: 12px;">
        {% csrf_token %}
        <select name="customer_id" id="customer-switcher" class="customer-switcher" onchange="switchCustomer(this.value)">
          {% for membership in user_customers %}
          <option value="{{ membership.customer.id }}" {% if membership.customer.id == active_customer_id %}selected{% endif %}>
            {{ membership.customer.name }}
          </option>
          {% endfor %}
        </select>
      </form>
      {% elif user_customers|length == 1 %}
      <span class="topbar-customer-name" style="margin-right: 12px; color: var(--muted); font-size: 13px;">{{ user_customers.0.customer.name }}</span>
      {% endif %}
      <span class="topbar-username">{{ request.user.username }}</span>
      <a class="topbar-btn" href="/portal/">Portal</a>
      {% if request.user.is_superuser %}
      <a class="topbar-btn" href="/admin/">Admin</a>
      {% endif %}
      <a class="topbar-btn" href="/account/logout/">Logout</a>
    </div>
  </header>
  
  <script>
    function switchCustomer(customerId) {
      const form = document.getElementById('customer-switcher-form');
      if (form && customerId) {
        form.action = '/portal/switch/' + customerId + '/';
        form.submit();
      }
    }
  </script>

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-section">
        <div class="footer-title">PMG Portal</div>
        <div class="footer-text">Version {{ app_version|default:"Unknown" }}</div>
        <div class="footer-text muted">Copyright &copy; {{ copyright_year|default:"2026" }} <a href="https://5echo.io" target="_blank" rel="noopener" class="footer-link">5echo.io</a></div>
        {% if show_changelog_button %}
        <a href="#" class="footer-link" onclick="openChangelogModal(); return false;" style="margin-top: 8px; display: inline-block;">View Changelog</a>
        {% endif %}
      </div>
    </div>
  </footer>

  <!-- Changelog Modal -->
  {% if show_changelog_button %}
  <div id="changelogModal" class="modal" onclick="closeChangelogModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Changelog - Version {{ app_version|default:"Unknown" }}</h2>
        <button class="modal-close" onclick="closeChangelogModal(event)">&times;</button>
      </div>
      <div class="modal-body">
        {% if changelog_section %}
        <div class="changelog-section">
          <pre class="changelog-content">{{ changelog_section|escape }}</pre>
        </div>
        {% endif %}
        {% if changelog_full %}
        <div class="modal-actions">
          <button class="modal-btn" onclick="toggleFullChangelog()">View Full Changelog</button>
        </div>
        <div id="fullChangelog" class="changelog-section" style="display: none;">
          <pre class="changelog-content">{{ changelog_full|escape }}</pre>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <script>
    function openChangelogModal() {
      document.getElementById('changelogModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    
    function closeChangelogModal(event) {
      if (!event || event.target.classList.contains('modal') || event.target.classList.contains('modal-close')) {
        document.getElementById('changelogModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        // Reset full changelog view
        const fullChangelog = document.getElementById('fullChangelog');
        if (fullChangelog) {
          fullChangelog.style.display = 'none';
        }
        const btn = document.querySelector('.modal-btn');
        if (btn) {
          btn.textContent = 'View Full Changelog';
        }
      }
    }
    
    function toggleFullChangelog() {
      const fullChangelog = document.getElementById('fullChangelog');
      const btn = document.querySelector('.modal-btn');
      if (fullChangelog && btn) {
        if (fullChangelog.style.display === 'none') {
          fullChangelog.style.display = 'block';
          btn.textContent = 'Hide Full Changelog';
        } else {
          fullChangelog.style.display = 'none';
          btn.textContent = 'View Full Changelog';
        }
      }
    }
    
    // Close on ESC key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('changelogModal');
        if (modal && modal.style.display === 'flex') {
          closeChangelogModal(event);
        }
      }
    });
  </script>
</body>
</html>
