{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}PMG Portal{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'app.css' %}">
</head>
<body class="page-wrapper">
  <header class="topbar">
    <div class="topbar-left">
      <div class="brand">PMG Portal</div>
      <div class="topbar-nav">
        <a class="topbar-btn {% if request.path == '/portal/' or request.path|slice:':8' == '/portal/' %}active{% endif %}" href="/portal/">Portal</a>
        {% if request.user.is_superuser %}
        <a class="topbar-btn {% if request.path|slice:':7' == '/admin/' %}active{% endif %}" href="/admin/">Admin</a>
        {% endif %}
      </div>
    </div>
    <div class="topbar-right">
      {% if user_customers|length > 1 %}
      <form method="post" action="" id="customer-switcher-form" class="customer-switcher-wrapper">
        {% csrf_token %}
        <select name="customer_id" id="customer-switcher" class="customer-switcher" onchange="switchCustomer(this.value)">
          {% for membership in user_customers %}
          <option value="{{ membership.customer.id }}" {% if membership.customer.id == active_customer_id %}selected{% endif %}>
            {{ membership.customer.name }}
          </option>
          {% endfor %}
        </select>
      </form>
      {% elif user_customers|length == 1 %}
      <span class="topbar-customer-name">{{ user_customers.0.customer.name }}</span>
      {% endif %}
      <div class="user-avatar-wrapper">
        <button class="user-avatar-btn" onclick="toggleUserMenu(event)" aria-label="User menu">
          <div class="user-avatar">
            {{ request.user.username|first|upper }}
          </div>
        </button>
        <div id="user-menu" class="user-menu">
          <div class="user-menu-header">
            <div class="user-menu-name">{% if request.user.first_name or request.user.last_name %}{{ request.user.first_name }} {{ request.user.last_name }}{% else %}{{ request.user.username }}{% endif %}</div>
            <div class="user-menu-email">{{ request.user.email|default:"" }}</div>
          </div>
        <div class="user-menu-divider"></div>
        <a href="/account/profile/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Profile Settings
        </a>
        {% if request.user.is_superuser %}
        <div class="user-menu-divider"></div>
        <a href="/admin/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          Admin Panel
        </a>
        <a href="/debug/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          Debug
        </a>
        {% endif %}
        <div class="user-menu-divider"></div>
        <a href="/account/logout/" class="user-menu-item">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          Logout
        </a>
        </div>
      </div>
    </div>
  </header>
  
  <script>
    function switchCustomer(customerId) {
      const form = document.getElementById('customer-switcher-form');
      if (form && customerId) {
        form.action = '/portal/switch/' + customerId + '/';
        form.submit();
      }
    }
    
    function toggleUserMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('user-menu');
      if (!menu) return;
      
      const isOpen = menu.classList.contains('open');
      
      // Close all menus
      document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
      
      if (!isOpen) {
        menu.classList.add('open');
        // Close on outside click
        setTimeout(() => {
          const closeHandler = function(e) {
            if (!menu.contains(e.target) && !e.target.closest('.user-avatar-btn')) {
              menu.classList.remove('open');
              document.removeEventListener('click', closeHandler);
            }
          };
          document.addEventListener('click', closeHandler, { once: true });
        }, 10);
      }
    }
    
    // Close menu on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
      }
    });
  </script>

  <main class="main-content">
    <div class="container">
      {% if messages %}
      <div class="toast-container">
        {% for message in messages %}
        <div class="toast toast-{{ message.tags }}" data-toast-id="{{ forloop.counter }}">
          <div class="toast-content">
            <span class="toast-message">{{ message }}</span>
            <button class="toast-close" onclick="dismissToast(this.parentElement.parentElement)">Ã—</button>
          </div>
        </div>
        {% endfor %}
      </div>
      <script>
        // Auto-dismiss toasts after 5 seconds
        document.querySelectorAll('.toast').forEach(function(toast) {
          setTimeout(function() {
            dismissToast(toast);
          }, 5000);
        });
        
        function dismissToast(toast) {
          if (toast) {
            toast.style.animation = 'toastSlideOut 0.3s ease-out';
            setTimeout(function() {
              toast.remove();
            }, 300);
          }
        }
      </script>
      {% endif %}
      {% block content %}{% endblock %}
    </div>
  </main>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-section">
        <div class="footer-title">PMG Portal</div>
        <div class="footer-text">Version {{ app_version|default:"Unknown" }}</div>
        <div class="footer-text muted">Copyright &copy; {{ copyright_year|default:"2026" }} <a href="https://5echo.io" target="_blank" rel="noopener" class="footer-link">5echo.io</a></div>
        {% if show_changelog_button %}
        <a href="#" class="footer-link" onclick="openChangelogModal(); return false;" style="margin-top: 8px; display: inline-block;">View Changelog</a>
        {% endif %}
      </div>
    </div>
  </footer>

  <!-- Changelog Modal -->
  {% if show_changelog_button %}
  <div id="changelogModal" class="modal" onclick="closeChangelogModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Changelog - Version {{ app_version|default:"Unknown" }}</h2>
        <button class="modal-close" onclick="closeChangelogModal(event)">&times;</button>
      </div>
      <div class="modal-body">
        {% if changelog_section %}
        <div class="changelog-section">
          <pre class="changelog-content">{{ changelog_section|escape }}</pre>
        </div>
        {% endif %}
        {% if changelog_full %}
        <div class="modal-actions">
          <button class="modal-btn" onclick="toggleFullChangelog()">View Full Changelog</button>
        </div>
        <div id="fullChangelog" class="changelog-section" style="display: none;">
          <pre class="changelog-content">{{ changelog_full|escape }}</pre>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <script>
    function openChangelogModal() {
      document.getElementById('changelogModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    
    function closeChangelogModal(event) {
      if (!event || event.target.classList.contains('modal') || event.target.classList.contains('modal-close')) {
        document.getElementById('changelogModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        // Reset full changelog view
        const fullChangelog = document.getElementById('fullChangelog');
        if (fullChangelog) {
          fullChangelog.style.display = 'none';
        }
        const btn = document.querySelector('.modal-btn');
        if (btn) {
          btn.textContent = 'View Full Changelog';
        }
      }
    }
    
    function toggleFullChangelog() {
      const fullChangelog = document.getElementById('fullChangelog');
      const btn = document.querySelector('.modal-btn');
      if (fullChangelog && btn) {
        if (fullChangelog.style.display === 'none') {
          fullChangelog.style.display = 'block';
          btn.textContent = 'Hide Full Changelog';
        } else {
          fullChangelog.style.display = 'none';
          btn.textContent = 'View Full Changelog';
        }
      }
    }
    
    // Close on ESC key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const modal = document.getElementById('changelogModal');
        if (modal && modal.style.display === 'flex') {
          closeChangelogModal(event);
        }
        document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
      }
    });
    
    // Make toggleUserMenu globally accessible
    window.toggleUserMenu = toggleUserMenu;
  </script>
</body>
</html>
