{% extends "portal/base.html" %}
{% load i18n static %}
{% block title %}{{ datasheet.title }} | {% trans "Product datasheet" %} | {% trans "PMG Portal" %}{% endblock %}

{% block content %}
<div class="datasheet-page">
  <!-- Breadcrumb: back to Product datasheets, not Dashboard -->
  <div class="breadcrumb-row no-print">
    <a href="{% url 'datasheet_list' %}" class="breadcrumb-back-btn" aria-label="{% trans 'Back to Product datasheets' %}" hx-get="{% url 'datasheet_list' %}" hx-target="#main-content" hx-push-url="true">← {% trans "Product datasheets" %}</a>
    <nav class="breadcrumb admin-breadcrumb" aria-label="Breadcrumb">
      <a href="/" hx-get="/" hx-target="#main-content" hx-push-url="true">{% trans "Dashboard" %}</a>
      <span class="breadcrumb-sep">→</span>
      <a href="{% url 'datasheet_list' %}" hx-get="{% url 'datasheet_list' %}" hx-target="#main-content" hx-push-url="true">{% trans "Product datasheets" %}</a>
      <span class="breadcrumb-sep">→</span>
      <span>{{ datasheet.title }}</span>
    </nav>
  </div>

  <div class="datasheet-layout">
    <!-- Table of contents: left, ~1/8, hidden in print/PDF -->
    <aside class="datasheet-toc-col no-print" id="datasheet-toc-wrap" aria-label="{% trans 'Table of contents' %}">
      <nav class="datasheet-toc" id="datasheet-toc">
        <div class="datasheet-toc-title">{% trans "Table of contents" %}</div>
        <ul class="datasheet-toc-list" id="datasheet-toc-list"></ul>
      </nav>
    </aside>

    <div class="datasheet-main-col">
      <div class="datasheet-header-row">
        <div class="datasheet-header-main">
          <h1 class="datasheet-title">{{ datasheet.title }}</h1>
          <p class="datasheet-meta">
            {% trans "Created" %}: {{ datasheet.uploaded_at|date:"Y-m-d H:i" }}
            &nbsp;·&nbsp;
            {% trans "Last updated" %}: {{ datasheet.updated_at|date:"Y-m-d H:i" }}
          </p>
        </div>
        <div class="datasheet-actions">
          <a href="{% url 'datasheet_pdf' device_type.slug %}" class="datasheet-action-btn" target="_blank" rel="noopener" data-tooltip="{% trans 'Download PDF' %}" title="{% trans 'Download PDF' %}" aria-label="{% trans 'Download PDF' %}">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M9 15l3 3 3-3"/></svg>
          </a>
          <button type="button" class="datasheet-action-btn" onclick="window.print()" data-tooltip="{% trans 'Print datasheet' %}" title="{% trans 'Print datasheet' %}" aria-label="{% trans 'Print datasheet' %}">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/></svg>
          </button>
          {% if datasheet.file %}
          <a href="{{ datasheet.file.url }}" target="_blank" rel="noopener" class="datasheet-action-btn" data-tooltip="{% trans 'Download manufacturer datasheet' %}" title="{% trans 'Download manufacturer datasheet' %}" aria-label="{% trans 'Download manufacturer datasheet' %}">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          </a>
          {% endif %}
        </div>
      </div>

      <div class="datasheet-body print-datasheet">
        {% if content_html %}
        <div class="datasheet-content markdown-body" id="datasheet-content">
          {{ content_html|safe }}
        </div>
        {% endif %}
        {% if datasheet.file and not content_html %}
        <p class="muted">{% trans "No Markdown content. Download the manufacturer PDF above." %}</p>
        {% endif %}
      </div>

      <footer class="datasheet-footer print-only">
        <p>© {{ datasheet.updated_at|date:"Y" }} Park Media Group AS</p>
      </footer>
    </div>
  </div>
</div>

<style>
.datasheet-page { width: 100%; padding: 0; }

/* Allow sticky TOC: avoid overflow:hidden on ancestors so position:sticky works */
.main-content:has(.datasheet-page),
#main-content:has(.datasheet-page) {
  overflow: visible;
}

.datasheet-layout {
  display: flex;
  gap: 48px;
  align-items: flex-start;
}
.datasheet-toc-col {
  flex: 0 0 12.5%;
  min-width: 140px;
  max-width: 200px;
  position: sticky;
  top: calc(56px + 24px);
  align-self: flex-start;
  max-height: calc(100vh - 56px - 48px);
  overflow-y: auto;
  background: var(--bg);
  z-index: 5;
  padding-right: 0;
  padding-top: 8px;
}
.datasheet-toc {
  padding: 12px 0;
  border-right: 1px solid var(--line, #d1d5db);
  padding-right: 80px;
}
.datasheet-main-col {
  flex: 1;
  min-width: 0;
  padding-left: 24px;
}
.datasheet-toc-title {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  margin-bottom: 8px;
}
.datasheet-toc-list {
  list-style: none;
  margin: 0;
  padding: 0;
  font-size: 0.875rem;
}
.datasheet-toc-list li { margin: 4px 0; }
.datasheet-toc-list a {
  color: var(--text);
  text-decoration: none;
  display: block;
  padding: 2px 0;
  border-left: 2px solid transparent;
  padding-left: 8px;
  margin-left: 0;
}
.datasheet-toc-list a:hover { color: var(--link); border-left-color: var(--link); }
.datasheet-toc-list .toc-h2 { padding-left: 8px; }
.datasheet-toc-list .toc-h3 { padding-left: 16px; }


.datasheet-header-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 24px;
  margin-bottom: 24px;
  flex-wrap: wrap;
  overflow: visible;
}
.datasheet-header-main { flex: 1; min-width: 0; }
.datasheet-title { font-size: 1.75rem; margin: 0 0 0.5rem 0; }
.datasheet-meta { color: var(--muted); font-size: 0.9rem; margin: 0; }

/* Action buttons: same height, vertically centered with each other */
.datasheet-actions {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
  align-items: stretch;
  overflow: visible;
}
.datasheet-action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 8px;
  background: var(--btn);
  border: 1px solid var(--line);
  color: var(--text);
  text-decoration: none;
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s, color 0.2s;
  position: relative;
  box-sizing: border-box;
  flex-shrink: 0;
  font: inherit;
  line-height: 0;
}
.datasheet-action-btn svg {
  stroke: currentColor;
  flex-shrink: 0;
  display: block;
  width: 20px;
  height: 20px;
}
.datasheet-action-btn:hover {
  background: var(--btnHover);
  border-color: var(--line);
  color: var(--text);
}
.datasheet-action-btn:focus {
  outline: 2px solid var(--link);
  outline-offset: 2px;
}
/* Tooltip: site design, high z-index; last button(s) show tooltip left-aligned to avoid right-edge clip */
.datasheet-action-btn[data-tooltip]:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: calc(100% + 8px);
  padding: 6px 10px;
  font-size: 0.8125rem;
  white-space: nowrap;
  background: var(--card);
  color: var(--text);
  border: 1px solid var(--line);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 99999;
  pointer-events: none;
}
.datasheet-action-btn[data-tooltip]:hover::before {
  content: '';
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: calc(100% + 2px);
  border: 6px solid transparent;
  border-top-color: var(--line);
  z-index: 100000;
  pointer-events: none;
}
.datasheet-actions .datasheet-action-btn:last-of-type[data-tooltip]:hover::after {
  left: auto;
  right: 0;
  transform: none;
}
.datasheet-actions .datasheet-action-btn:last-of-type[data-tooltip]:hover::before {
  left: auto;
  right: 12px;
  transform: none;
}

.datasheet-body { margin-top: 0; }
.markdown-body { line-height: 1.5; font-size: 0.9375rem; }
.markdown-body h1 { font-size: 1.15rem; margin-top: 1.25rem; }
.markdown-body h2 { font-size: 1rem; margin-top: 1.5rem; }
.markdown-body h3 { font-size: 0.95rem; margin-top: 1.25rem; }
.markdown-body h2:first-child { margin-top: 0; }
.markdown-body h3:first-child { margin-top: 0; }
.markdown-body table { border-collapse: collapse; width: 100%; margin: 0.75rem 0; }
.markdown-body th, .markdown-body td { border: 1px solid var(--line, #ddd); padding: 0.5rem 0.75rem; text-align: left; }
.markdown-body th { background: var(--line); color: var(--text); font-weight: 600; }

.datasheet-footer.print-only { display: none; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--line); font-size: 0.85rem; color: var(--muted); }

.markdown-body table,
.markdown-body h1,
.markdown-body h2,
.markdown-body h3 {
  page-break-inside: avoid;
}
.markdown-body h2 { page-break-after: avoid; }
.markdown-body h3 { page-break-after: avoid; }

/* Scroll margin so TOC targets are not hidden under topbar */
.markdown-body h1[id], .markdown-body h2[id], .markdown-body h3[id] {
  scroll-margin-top: 80px;
}

@media print {
  .no-print,
  .datasheet-toc-col,
  .breadcrumb-row,
  .datasheet-actions,
  .topbar,
  .site-footer-wrapper,
  .footer,
  .loading-indicator,
  .toast-container,
  .toast {
    display: none !important;
  }
  body { padding: 0; background: #fff; color: #000 !important; }
  .main-content { padding: 0; }
  .main-content .container { max-width: none; padding: 16px 24px; }
  .datasheet-page { padding: 0; }
  .datasheet-layout { display: block; }
  .datasheet-header-row { margin-bottom: 16px; }
  .print-only { display: block !important; }
  .print-datasheet,
  .print-datasheet *,
  .datasheet-title,
  .datasheet-meta {
    color: #000 !important;
  }
  .datasheet-meta { opacity: 1; }
  .datasheet-footer.print-only {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    text-align: center;
    padding: 8px 0;
    font-size: 0.85rem;
    color: #000 !important;
    border-top: 1px solid #eee;
  }
}
</style>

<script>
(function() {
  var content = document.getElementById('datasheet-content');
  var tocList = document.getElementById('datasheet-toc-list');
  if (!content || !tocList) return;
  var headings = content.querySelectorAll('h1, h2, h3');
  if (headings.length === 0) {
    document.getElementById('datasheet-toc-wrap').style.display = 'none';
    return;
  }
  function slugify(text) {
    return text.trim().toLowerCase()
      .replace(/\s+/g, '-')
      .replace(/[^\w\u00C0-\u024F\-]/g, '')
      .replace(/-+/g, '-')
      .replace(/^-|-$/g, '') || 'section';
  }
  var seen = {};
  headings.forEach(function(h, i) {
    var id = slugify(h.textContent);
    if (seen[id]) { seen[id]++; id = id + '-' + seen[id]; } else { seen[id] = 1; }
    h.id = id;
    var li = document.createElement('li');
    li.className = 'toc-' + h.tagName.toLowerCase();
    var a = document.createElement('a');
    a.href = '#' + id;
    a.textContent = h.textContent.trim();
    a.addEventListener('click', function(e) {
      e.preventDefault();
      var el = document.getElementById(id);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, '', '#' + id);
      }
    });
    li.appendChild(a);
    tocList.appendChild(li);
  });
})();
</script>
{% endblock %}
