{% extends "portal/base.html" %}
{% load i18n static %}
{% block title %}{% trans "Servicerapport" %}: {{ service_log.service_id }} | {{ facility.name }} | {% trans "PMG Portal" %}{% endblock %}

{% block content %}
<div class="facility-detail-container{% if print_mode %} servicerapport-print-view{% endif %}">
  {% if not print_mode %}
  <div class="breadcrumb-row">
    <a href="{% url 'facility_detail' facility.slug %}#servicelogg" class="breadcrumb-back-btn" aria-label="{% trans 'Back to facility' %}">← {{ facility.name }}</a>
    <nav class="breadcrumb admin-breadcrumb" aria-label="Breadcrumb">
      <a href="{% url 'facility_list' %}">{% trans "Facilities" %}</a>
      <span class="breadcrumb-sep">→</span>
      <a href="{% url 'facility_detail' facility.slug %}#servicelogg">{{ facility.name }}</a>
      <span class="breadcrumb-sep">→</span>
      <span>{% trans "Servicerapport" %}: {{ service_log.service_id }}</span>
    </nav>
  </div>

  <div class="customer-card-container">
    <div class="customer-card-header" style="padding-bottom: 16px;">
      <div class="customer-card-info" style="flex: 1;">
        <h1 class="customer-card-name" style="margin: 0 0 8px 0;">{% trans "Servicerapport" %}</h1>
        <p class="customer-card-slug" style="margin: 0;">{{ facility.name }} — {{ service_log.service_id }}</p>
      </div>
      <div class="customer-card-header-actions">
        <a href="{% url 'facility_service_log_pdf' facility.slug service_log.pk %}" target="_blank" rel="noopener" class="customer-card-icon-btn" title="{% trans 'Print report' %}" aria-label="{% trans 'Print report' %}">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/></svg>
        </a>
      </div>
    </div>

    <div class="panel" style="margin-top: 24px;">
      <dl class="service-log-dl">
        <dt>{% trans "Service ID" %}</dt>
        <dd><strong>{{ service_log.service_id }}</strong>{% if service_log.external_id %} <span class="muted">({{ service_log.external_id }})</span>{% endif %}</dd>

        {% if service_log.service_type %}
        <dt>{% trans "Type" %}</dt>
        <dd>{{ service_log.service_type.name }}</dd>
        {% endif %}

        <dt>{% trans "Performed at" %}</dt>
        <dd>{{ service_log.performed_at|date:"d.m.Y H:i" }}</dd>

        <dt>{% trans "Technician" %}</dt>
        <dd>{{ service_log.technician_employee_no|default:"—" }}</dd>

        {% if service_log.asset_name or service_log.asset_id %}
        <dt>{% trans "Asset" %}</dt>
        <dd>{{ service_log.asset_name|default:"" }}{% if service_log.asset_id %} ({{ service_log.asset_id }}){% endif %}</dd>
        {% endif %}
        {% if service_log.customer_name %}
        <dt>{% trans "Customer" %}</dt>
        <dd>{{ service_log.customer_name }}{% if service_log.contract_number %} — {% trans "Avtalenummer" %}: {{ service_log.contract_number }}{% endif %}</dd>
        {% endif %}

        {% if service_log.background %}
        <dt>{% trans "Bakgrunn" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.background }}</div></dd>
        {% endif %}
        {% if service_log.summary %}
        <dt>{% trans "Oppsummering" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.summary }}</div></dd>
        {% endif %}

        <dt>{% trans "Rapport" %}</dt>
        <dd>{% if service_log.description %}<div style="white-space: pre-wrap;">{{ service_log.description }}</div>{% else %}—{% endif %}</dd>

        {% if service_log.findings_observations %}
        <dt>{% trans "Funn og observasjoner" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.findings_observations }}</div></dd>
        {% endif %}
        {% if service_log.conclusion %}
        <dt>{% trans "Konklusjon" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.conclusion }}</div></dd>
        {% endif %}
        {% if service_log.recommendations_immediate or service_log.recommendations_long_term %}
        <dt>{% trans "Anbefalinger" %}</dt>
        <dd>
          {% if service_log.recommendations_immediate %}<p><strong>{% trans "Umiddelbare tiltak" %}</strong></p><div style="white-space: pre-wrap;">{{ service_log.recommendations_immediate }}</div>{% endif %}
          {% if service_log.recommendations_long_term %}<p style="margin-top: 8px;"><strong>{% trans "Langsiktige tiltak" %}</strong></p><div style="white-space: pre-wrap;">{{ service_log.recommendations_long_term }}</div>{% endif %}
        </dd>
        {% endif %}

        {% if service_log.serviced_devices.all %}
        <dt>{% trans "Enheter som ble servet" %}</dt>
        <dd>
          <ul style="margin: 0; padding-left: 20px;">
            {% for sd in service_log.serviced_devices.all %}
            <li>{{ sd.device.name }}{% if sd.serviced_at %} ({{ sd.serviced_at|date:"d.m.Y H:i" }}){% endif %}{% if sd.notes %} — {{ sd.notes }}{% endif %}</li>
            {% endfor %}
          </ul>
        </dd>
        {% endif %}

        {% if service_log.notes %}
        <dt>{% trans "Notes" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.notes }}</div></dd>
        {% endif %}

        {% if service_log.sla_deadline %}
        <dt>{% trans "SLA deadline" %}</dt>
        <dd>{{ service_log.sla_deadline|date:"d.m.Y H:i" }}{% if service_log.sla_met is not None %} — {% if service_log.sla_met %}{% trans "SLA met" %}{% else %}{% trans "SLA not met" %}{% endif %}{% endif %}</dd>
        {% endif %}

        {% if service_log.approved_at %}
        <dt>{% trans "Approved" %}</dt>
        <dd>{{ service_log.approved_at|date:"d.m.Y H:i" }}{% if service_log.approved_by %} {% trans "by" %} {{ service_log.approved_by.get_full_name|default:service_log.approved_by.username }}{% endif %}{% if service_log.signature_notes %} — {{ service_log.signature_notes }}{% endif %}</dd>
        {% endif %}

        {% if service_log.attachments.all %}
        <dt>{% trans "Attachments" %}</dt>
        <dd>
          <ul class="service-log-attachments" style="margin: 0; padding-left: 20px;">
            {% for att in service_log.attachments.all %}
            <li><a href="{{ att.file.url }}" target="_blank" rel="noopener">{{ att.title|default:att.file.name }}</a></li>
            {% endfor %}
          </ul>
        </dd>
        {% endif %}

        <dt>{% trans "Created" %}</dt>
        <dd>{{ service_log.created_at|date:"d.m.Y H:i" }}{% if service_log.created_by %} {% trans "by" %} {{ service_log.created_by.get_full_name|default:service_log.created_by.username }}{% endif %}</dd>
      </dl>
    </div>
  </div>
  {% endif %}
</div>

{% if print_mode %}
<div class="servicerapport-print-document" id="servicerapport-print-content">
  <table class="sr-print-table sr-print-table-main">
    <tr>
      <td class="sr-print-title-cell">{% trans "Servicerapport" %} {{ service_log.service_id }}{% if service_log.asset_name %} {{ service_log.asset_name }}{% endif %}</td>
      <td class="sr-print-meta-cell">
        <span class="sr-print-meta-line">{{ service_log.performed_at|date:"Y-m-d" }}{% if service_log.technician_employee_no %} {{ service_log.technician_employee_no }}{% endif %} {{ facility.name }}</span>
        {% if facility.address %}<span class="sr-print-meta-line">{{ facility.address }}</span>{% endif %}
        {% if service_log.customer_name %}<span class="sr-print-meta-line">{{ service_log.customer_name }}{% if service_log.customer_address %} {{ service_log.customer_address }}{% endif %}{% if service_log.customer_org_numbers %} {{ service_log.customer_org_numbers }}{% endif %}</span>{% endif %}
        {% if service_log.contract_number or service_log.asset_id %}<span class="sr-print-meta-line">{% if service_log.contract_number %}{% trans "Avtalenummer" %}: {{ service_log.contract_number }}{% endif %}{% if service_log.contract_number and service_log.asset_id %} {% endif %}{% if service_log.asset_id %}Asset ID: {{ service_log.asset_id }}{% endif %}</span>{% endif %}
      </td>
    </tr>
  </table>
  <table class="sr-print-table sr-print-table-parties">
    <tr>
      <td>{% trans "Leverandøren" %}: {% if service_log.supplier_name %}{{ service_log.supplier_name }}{% if service_log.supplier_org_number %} {{ service_log.supplier_org_number }}{% endif %}{% else %}—{% endif %}</td>
      <td>{% trans "Kunden" %}: {% if service_log.customer_name %}{{ service_log.customer_name }}{% if service_log.customer_org_numbers %} {{ service_log.customer_org_numbers }}{% endif %}{% else %}—{% endif %}</td>
    </tr>
    <tr class="sr-print-sign-row">
      <td><span class="sr-print-sign-line">_____________________________</span> <em>Sign. {% trans "Leverandøren" %}</em></td>
      <td><span class="sr-print-sign-line">_____________________________</span> <em>Sign. {% trans "Kunden" %}</em></td>
    </tr>
  </table>

  <h2 class="sr-print-h2">{% trans "Sammendrag" %}</h2>
  <div class="sr-print-underline"></div>
  {% if service_log.background %}
  <h3 class="sr-print-h3">{% trans "Bakgrunn" %}</h3>
  <div class="sr-print-text">{{ service_log.background|linebreaks }}</div>
  {% endif %}
  {% if service_log.summary %}
  <h3 class="sr-print-h3">{% trans "Oppsummering" %}</h3>
  <div class="sr-print-text">{{ service_log.summary|linebreaks }}</div>
  {% endif %}

  <h2 class="sr-print-h2">{% trans "Rapport" %}</h2>
  <div class="sr-print-underline"></div>
  <div class="sr-print-text">{% if service_log.description %}{{ service_log.description|linebreaks }}{% else %}—{% endif %}</div>

  <h2 class="sr-print-h2">{% trans "Funn og observasjoner" %}</h2>
  <div class="sr-print-underline"></div>
  <div class="sr-print-text">{% if service_log.findings_observations %}{{ service_log.findings_observations|linebreaks }}{% else %}—{% endif %}</div>

  <h2 class="sr-print-h2">{% trans "Konklusjon" %}</h2>
  <div class="sr-print-underline"></div>
  <div class="sr-print-text">{% if service_log.conclusion %}{{ service_log.conclusion|linebreaks }}{% else %}—{% endif %}</div>

  <h2 class="sr-print-h2">{% trans "Anbefalinger" %}</h2>
  <div class="sr-print-underline"></div>
  {% if service_log.recommendations_immediate %}
  <h3 class="sr-print-h3">{% trans "Umiddelbare tiltak" %}</h3>
  <div class="sr-print-text">{{ service_log.recommendations_immediate|linebreaks }}</div>
  {% endif %}
  {% if service_log.recommendations_long_term %}
  <h3 class="sr-print-h3">{% trans "Langsiktige tiltak" %}</h3>
  <div class="sr-print-text">{{ service_log.recommendations_long_term|linebreaks }}</div>
  {% endif %}
  {% if not service_log.recommendations_immediate and not service_log.recommendations_long_term %}
  <div class="sr-print-text">—</div>
  {% endif %}

  <h2 class="sr-print-h2">{% trans "Vedlegg" %}</h2>
  <div class="sr-print-underline"></div>
  {% if service_log.attachments.all %}
  <ul class="sr-print-list">{% for att in service_log.attachments.all %}<li>{{ att.title|default:att.file.name }}</li>{% endfor %}</ul>
  {% else %}
  <p class="sr-print-text">{% trans "None" %}</p>
  {% endif %}

  <p class="sr-print-footer">{% trans "Servicerapport" %}: {{ service_log.service_id }} | {{ facility.name }} | {{ service_log.performed_at|date:"d.m.Y" }}</p>
</div>
<script>window.onload = function() { window.print(); }</script>
{% endif %}

<style>
.service-log-dl { display: grid; grid-template-columns: 180px 1fr; gap: 12px 24px; margin: 0; }
.service-log-dl dt { font-weight: 600; color: var(--muted, #6b7280); }
.service-log-dl dd { margin: 0; }
@media (max-width: 640px) { .service-log-dl { grid-template-columns: 1fr; } }
/* Print view: hide normal content when printing report layout */
.servicerapport-print-view .breadcrumb-row,
.servicerapport-print-view .customer-card-header,
.servicerapport-print-view .panel { display: none !important; }
.servicerapport-print-view .servicerapport-print-document { display: block !important; }

/* PDF-style servicerapport (matches RQ-2690 template) */
.servicerapport-print-document { max-width: 210mm; margin: 0 auto; padding: 16mm; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; font-size: 10pt; line-height: 1.4; color: #000; }
.sr-print-table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
.sr-print-table td { vertical-align: top; padding: 6px 10px; border: 1px solid #000; font-size: 10pt; }
.sr-print-table-main .sr-print-title-cell { font-weight: bold; font-size: 12pt; width: 45%; }
.sr-print-table-main .sr-print-meta-cell { font-size: 9pt; color: #333; }
.sr-print-meta-line { display: block; margin-bottom: 2px; }
.sr-print-table-parties td { width: 50%; font-size: 9pt; }
.sr-print-sign-row td { padding-top: 20px; font-size: 9pt; color: #333; }
.sr-print-sign-line { display: inline-block; min-width: 180px; border-bottom: 1px solid #000; margin-right: 8px; }
.sr-print-h2 { font-size: 12pt; font-weight: bold; margin: 18px 0 4px 0; }
.sr-print-underline { border-bottom: 1px solid #000; margin-bottom: 10px; }
.sr-print-h3 { font-size: 11pt; font-weight: bold; margin: 12px 0 4px 0; }
.sr-print-text { margin: 0 0 10px 0; white-space: pre-wrap; }
.sr-print-list { margin: 0 0 10px 0; padding-left: 20px; }
.sr-print-footer { margin-top: 24px; padding-top: 10px; border-top: 1px solid #999; font-size: 9pt; color: #666; }
@media print {
  html, body { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  body * { visibility: hidden; }
  .servicerapport-print-document, .servicerapport-print-document * { visibility: visible; }
  .servicerapport-print-document { position: absolute; left: 0; top: 0; width: 100%; padding: 16mm; max-width: none; background: #fff !important; }
  .sr-print-table td { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}
</style>
{% endblock %}
