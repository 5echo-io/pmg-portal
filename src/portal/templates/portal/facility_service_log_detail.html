{% extends "portal/base.html" %}
{% load i18n static %}
{% block title %}{% trans "Servicerapport" %}: {{ service_log.service_id }} | {{ facility.name }} | {% trans "PMG Portal" %}{% endblock %}

{% block content %}
<div class="facility-detail-container{% if print_mode %} servicerapport-print-view{% endif %}">
  {% if not print_mode %}
  <div class="breadcrumb-row">
    <a href="{% url 'facility_detail' facility.slug %}" class="breadcrumb-back-btn" aria-label="{% trans 'Back to facility' %}">‚Üê {{ facility.name }}</a>
    <nav class="breadcrumb admin-breadcrumb" aria-label="Breadcrumb">
      <a href="{% url 'facility_list' %}">{% trans "Facilities" %}</a>
      <span class="breadcrumb-sep">‚Üí</span>
      <a href="{% url 'facility_detail' facility.slug %}">{{ facility.name }}</a>
      <span class="breadcrumb-sep">‚Üí</span>
      <span>{% trans "Servicerapport" %}: {{ service_log.service_id }}</span>
    </nav>
  </div>

  <div class="customer-card-container">
    <div class="customer-card-header" style="padding-bottom: 16px;">
      <div class="customer-card-info" style="flex: 1;">
        <h1 class="customer-card-name" style="margin: 0 0 8px 0;">{% trans "Servicerapport" %}</h1>
        <p class="customer-card-slug" style="margin: 0;">{{ facility.name }} ‚Äî {{ service_log.service_id }}</p>
      </div>
      <div class="customer-card-header-actions">
        <a href="{% url 'facility_service_log_detail' facility.slug service_log.pk %}?print=1" target="_blank" class="admin-btn admin-btn-secondary">üñ® {% trans "Print report" %}</a>
        <a href="{% url 'facility_detail' facility.slug %}" class="admin-btn admin-btn-secondary">‚Üê {% trans "Back to facility" %}</a>
      </div>
    </div>

    <div class="panel" style="margin-top: 24px;">
      <dl class="service-log-dl">
        <dt>{% trans "Service ID" %}</dt>
        <dd><strong>{{ service_log.service_id }}</strong>{% if service_log.external_id %} <span class="muted">({{ service_log.external_id }})</span>{% endif %}</dd>

        {% if service_log.service_type %}
        <dt>{% trans "Type" %}</dt>
        <dd>{{ service_log.service_type.name }}</dd>
        {% endif %}

        <dt>{% trans "Performed at" %}</dt>
        <dd>{{ service_log.performed_at|date:"d.m.Y H:i" }}</dd>

        <dt>{% trans "Technician" %}</dt>
        <dd>{{ service_log.technician_employee_no|default:"‚Äî" }}</dd>

        {% if service_log.asset_name or service_log.asset_id %}
        <dt>{% trans "Asset" %}</dt>
        <dd>{{ service_log.asset_name|default:"" }}{% if service_log.asset_id %} ({{ service_log.asset_id }}){% endif %}</dd>
        {% endif %}
        {% if service_log.customer_name %}
        <dt>{% trans "Customer" %}</dt>
        <dd>{{ service_log.customer_name }}{% if service_log.contract_number %} ‚Äî {% trans "Avtalenummer" %}: {{ service_log.contract_number }}{% endif %}</dd>
        {% endif %}

        {% if service_log.background %}
        <dt>{% trans "Bakgrunn" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.background }}</div></dd>
        {% endif %}
        {% if service_log.summary %}
        <dt>{% trans "Oppsummering" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.summary }}</div></dd>
        {% endif %}

        <dt>{% trans "Rapport" %}</dt>
        <dd>{% if service_log.description %}<div style="white-space: pre-wrap;">{{ service_log.description }}</div>{% else %}‚Äî{% endif %}</dd>

        {% if service_log.findings_observations %}
        <dt>{% trans "Funn og observasjoner" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.findings_observations }}</div></dd>
        {% endif %}
        {% if service_log.conclusion %}
        <dt>{% trans "Konklusjon" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.conclusion }}</div></dd>
        {% endif %}
        {% if service_log.recommendations_immediate or service_log.recommendations_long_term %}
        <dt>{% trans "Anbefalinger" %}</dt>
        <dd>
          {% if service_log.recommendations_immediate %}<p><strong>{% trans "Umiddelbare tiltak" %}</strong></p><div style="white-space: pre-wrap;">{{ service_log.recommendations_immediate }}</div>{% endif %}
          {% if service_log.recommendations_long_term %}<p style="margin-top: 8px;"><strong>{% trans "Langsiktige tiltak" %}</strong></p><div style="white-space: pre-wrap;">{{ service_log.recommendations_long_term }}</div>{% endif %}
        </dd>
        {% endif %}

        {% if service_log.serviced_devices.all %}
        <dt>{% trans "Enheter som ble servet" %}</dt>
        <dd>
          <ul style="margin: 0; padding-left: 20px;">
            {% for sd in service_log.serviced_devices.all %}
            <li>{{ sd.device.name }}{% if sd.serviced_at %} ({{ sd.serviced_at|date:"d.m.Y H:i" }}){% endif %}{% if sd.notes %} ‚Äî {{ sd.notes }}{% endif %}</li>
            {% endfor %}
          </ul>
        </dd>
        {% endif %}

        {% if service_log.notes %}
        <dt>{% trans "Notes" %}</dt>
        <dd><div style="white-space: pre-wrap;">{{ service_log.notes }}</div></dd>
        {% endif %}

        {% if service_log.sla_deadline %}
        <dt>{% trans "SLA deadline" %}</dt>
        <dd>{{ service_log.sla_deadline|date:"d.m.Y H:i" }}{% if service_log.sla_met is not None %} ‚Äî {% if service_log.sla_met %}{% trans "SLA met" %}{% else %}{% trans "SLA not met" %}{% endif %}{% endif %}</dd>
        {% endif %}

        {% if service_log.approved_at %}
        <dt>{% trans "Approved" %}</dt>
        <dd>{{ service_log.approved_at|date:"d.m.Y H:i" }}{% if service_log.approved_by %} {% trans "by" %} {{ service_log.approved_by.get_full_name|default:service_log.approved_by.username }}{% endif %}{% if service_log.signature_notes %} ‚Äî {{ service_log.signature_notes }}{% endif %}</dd>
        {% endif %}

        {% if service_log.attachments.all %}
        <dt>{% trans "Attachments" %}</dt>
        <dd>
          <ul class="service-log-attachments" style="margin: 0; padding-left: 20px;">
            {% for att in service_log.attachments.all %}
            <li><a href="{{ att.file.url }}" target="_blank" rel="noopener">{{ att.title|default:att.file.name }}</a></li>
            {% endfor %}
          </ul>
        </dd>
        {% endif %}

        <dt>{% trans "Created" %}</dt>
        <dd>{{ service_log.created_at|date:"d.m.Y H:i" }}{% if service_log.created_by %} {% trans "by" %} {{ service_log.created_by.get_full_name|default:service_log.created_by.username }}{% endif %}</dd>
      </dl>
    </div>
  </div>
  {% endif %}
</div>

{% if print_mode %}
<div class="servicerapport-print-document" id="servicerapport-print-content">
  <div class="servicerapport-print-header">
    <h1 class="servicerapport-print-title">{% trans "Servicerapport" %}</h1>
    <p class="servicerapport-print-subtitle">{{ service_log.service_id }}{% if service_log.asset_name %} {{ service_log.asset_name }}{% endif %} | {{ service_log.performed_at|date:"Y-m-d" }}</p>
    {% if service_log.asset_name or service_log.asset_id %}<p class="servicerapport-print-asset">{% if service_log.asset_name %}{{ service_log.asset_name }}{% endif %}{% if service_log.asset_id %} {{ service_log.asset_id }}{% endif %}</p>{% endif %}
    {% if facility.address %}<p>{{ facility.address }}</p>{% endif %}
    {% if service_log.customer_name %}<p>{{ service_log.customer_name }}</p>{% endif %}
    {% if service_log.customer_address %}<p>{{ service_log.customer_address }}</p>{% endif %}
    {% if service_log.customer_org_numbers %}<p>{{ service_log.customer_org_numbers }}</p>{% endif %}
    {% if service_log.contract_number %}<p>{% trans "Avtalenummer" %}: {{ service_log.contract_number }}</p>{% endif %}
    {% if service_log.asset_id %}<p>Asset ID: {{ service_log.asset_id }}</p>{% endif %}
    {% if service_log.supplier_name %}<p>{% trans "Leverand√∏ren" %}: {{ service_log.supplier_name }}{% if service_log.supplier_org_number %} {{ service_log.supplier_org_number }}{% endif %}</p>{% endif %}
    {% if service_log.customer_name %}<p>{% trans "Kunden" %}: {{ service_log.customer_name }}{% if service_log.customer_org_numbers %} {{ service_log.customer_org_numbers }}{% endif %}</p>{% endif %}
  </div>
  <div class="servicerapport-print-section">
    <h2>{% trans "Sammendrag" %}</h2>
    {% if service_log.background %}<h3>{% trans "Bakgrunn" %}</h3><div class="servicerapport-print-text">{{ service_log.background|linebreaks }}</div>{% endif %}
    {% if service_log.summary %}<h3>{% trans "Oppsummering" %}</h3><div class="servicerapport-print-text">{{ service_log.summary|linebreaks }}</div>{% endif %}
  </div>
  <div class="servicerapport-print-section">
    <h2>{% trans "Rapport" %}</h2>
    <div class="servicerapport-print-text">{% if service_log.description %}{{ service_log.description|linebreaks }}{% else %}‚Äî{% endif %}</div>
  </div>
  {% if service_log.findings_observations %}
  <div class="servicerapport-print-section">
    <h2>{% trans "Funn og observasjoner" %}</h2>
    <div class="servicerapport-print-text">{{ service_log.findings_observations|linebreaks }}</div>
  </div>
  {% endif %}
  {% if service_log.conclusion %}
  <div class="servicerapport-print-section">
    <h2>{% trans "Konklusjon" %}</h2>
    <div class="servicerapport-print-text">{{ service_log.conclusion|linebreaks }}</div>
  </div>
  {% endif %}
  {% if service_log.recommendations_immediate or service_log.recommendations_long_term %}
  <div class="servicerapport-print-section">
    <h2>{% trans "Anbefalinger" %}</h2>
    {% if service_log.recommendations_immediate %}<h3>{% trans "Umiddelbare tiltak" %}</h3><div class="servicerapport-print-text">{{ service_log.recommendations_immediate|linebreaks }}</div>{% endif %}
    {% if service_log.recommendations_long_term %}<h3>{% trans "Langsiktige tiltak" %}</h3><div class="servicerapport-print-text">{{ service_log.recommendations_long_term|linebreaks }}</div>{% endif %}
  </div>
  {% endif %}
  {% if service_log.attachments.all %}
  <div class="servicerapport-print-section">
    <h2>{% trans "Vedlegg" %}</h2>
    <ul>{% for att in service_log.attachments.all %}<li>{{ att.title|default:att.file.name }}</li>{% endfor %}</ul>
  </div>
  {% else %}
  <div class="servicerapport-print-section">
    <h2>{% trans "Vedlegg" %}</h2>
    <p>{% trans "None" %}</p>
  </div>
  {% endif %}
  <p class="servicerapport-print-footer">{% trans "Servicerapport" %}: {{ service_log.service_id }} | {{ facility.name }} | {{ service_log.performed_at|date:"d.m.Y" }}</p>
</div>
<script>window.onload = function() { window.print(); }</script>
{% endif %}

<style>
.service-log-dl { display: grid; grid-template-columns: 180px 1fr; gap: 12px 24px; margin: 0; }
.service-log-dl dt { font-weight: 600; color: var(--muted, #6b7280); }
.service-log-dl dd { margin: 0; }
@media (max-width: 640px) { .service-log-dl { grid-template-columns: 1fr; } }
/* Print view: hide normal content when printing report layout */
.servicerapport-print-view .breadcrumb-row,
.servicerapport-print-view .customer-card-header,
.servicerapport-print-view .panel { display: none !important; }
.servicerapport-print-view .servicerapport-print-document { display: block !important; }
.servicerapport-print-document { max-width: 800px; margin: 0 auto; padding: 24px; font-family: Georgia, serif; font-size: 11pt; line-height: 1.5; color: #111; }
.servicerapport-print-document .servicerapport-print-title { font-size: 18pt; margin: 0 0 4px 0; }
.servicerapport-print-document .servicerapport-print-subtitle { font-size: 12pt; margin: 0 0 16px 0; color: #333; }
.servicerapport-print-document .servicerapport-print-header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #ccc; }
.servicerapport-print-document .servicerapport-print-header p { margin: 4px 0; font-size: 10pt; }
.servicerapport-print-document .servicerapport-print-section { margin-bottom: 20px; }
.servicerapport-print-document .servicerapport-print-section h2 { font-size: 12pt; margin: 16px 0 8px 0; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
.servicerapport-print-document .servicerapport-print-section h3 { font-size: 11pt; margin: 12px 0 4px 0; }
.servicerapport-print-document .servicerapport-print-text { white-space: pre-wrap; }
.servicerapport-print-document .servicerapport-print-footer { margin-top: 32px; padding-top: 12px; border-top: 1px solid #ccc; font-size: 9pt; color: #666; }
@media print {
  body * { visibility: hidden; }
  .servicerapport-print-document, .servicerapport-print-document * { visibility: visible; }
  .servicerapport-print-document { position: absolute; left: 0; top: 0; width: 100%; padding: 0; }
}
</style>
{% endblock %}
