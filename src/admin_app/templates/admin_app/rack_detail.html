{% extends "admin_app/base.html" %}
{% load static %}

{% block admin_title %}{{ rack.name }}{% endblock %}
{% block breadcrumb_back %}<a href="{% url 'admin_app:admin_facility_detail' facility.slug %}" class="breadcrumb-back-btn" aria-label="Back to {{ facility.name }}">← {{ facility.name }}</a>{% endblock %}
{% block breadcrumb_extra %}
<span class="breadcrumb-sep">→</span> <a href="{% url 'admin_app:admin_facility_list' %}">Facilities</a>
<span class="breadcrumb-sep">→</span> <a href="{% url 'admin_app:admin_facility_detail' facility.slug %}">{{ facility.name }}</a>
<span class="breadcrumb-sep">→</span> <span>{{ rack.name }}</span>
{% endblock %}

{% block admin_content %}
{% csrf_token %}
<div class="rack-detail-container">
  <!-- Rack info card (top box) -->
  <div class="rack-card-header customer-card-header">
    <div class="customer-card-logo-section">
      <div class="customer-logo-upload-area rack-card-icon-wrap" style="cursor: default;">
        <div class="customer-logo-placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect>
            <line x1="8" y1="2" x2="8" y2="22"></line>
            <line x1="16" y1="2" x2="16" y2="22"></line>
            <line x1="2" y1="8" x2="22" y2="8"></line>
            <line x1="2" y1="16" x2="22" y2="16"></line>
          </svg>
          <span>Rack</span>
        </div>
      </div>
    </div>
    <div class="customer-card-info">
      <div class="customer-card-name-wrapper">
        <div class="customer-card-title-block">
          <h1 class="customer-card-name">{{ rack.name }}</h1>
          <span class="customer-card-slug">{{ rack.height_units }}U{% if rack.location %} · {{ rack.location }}{% endif %}{% if rack.serial_number %} · {{ rack.serial_number }}{% endif %}</span>
        </div>
        <div class="customer-card-header-actions">
          <span class="customer-card-badge customer-card-badge--{% if rack.is_active %}active{% else %}inactive{% endif %}">{% if rack.is_active %}Active{% else %}Inactive{% endif %}</span>
          <a href="{% url 'admin_app:admin_rack_edit' facility.slug rack.pk %}" class="customer-card-icon-btn customer-card-icon-btn--edit" title="Edit Rack">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </a>
          <a href="{% url 'admin_app:admin_rack_seal_add' facility.slug rack.pk %}" class="form-btn form-btn-primary form-btn--narrow">Add Seal</a>
        </div>
      </div>
      <p class="customer-card-meta">Created {{ rack.created_at|date:"M j, Y" }} · Updated {{ rack.updated_at|date:"M j, Y" }}</p>
      {% if rack.description %}
      <p class="customer-card-org" style="white-space: pre-wrap;">{{ rack.description }}</p>
      {% endif %}
    </div>
  </div>

  <!-- Tabs -->
  <div class="rack-detail-tabs customer-card-tabs">
    <button class="rack-tab customer-tab active" data-tab="visual">Visual Rack</button>
    <button class="rack-tab customer-tab" data-tab="devices">Devices ({{ devices|length }})</button>
    <button class="rack-tab customer-tab" data-tab="seals">Seals ({{ active_seals|length }})</button>
  </div>

  <!-- Tab Content -->
  <div class="rack-detail-content">
    <!-- Visual Rack Tab -->
    <div class="rack-tab-panel active" id="tab-visual">
      <div class="rack-visual-container">
        <div class="rack-visual-header">
          <h2>Rack Front View - {{ rack.height_units }}U</h2>
          <button type="button" class="form-btn form-btn-primary form-btn--narrow" onclick="addDeviceToRack()">Add Device</button>
        </div>
        <div class="rack-visual">
          {% for u in u_positions %}
          <div class="rack-unit" data-u="{{ u }}">
            <div class="rack-unit-number">{{ u }}</div>
            <div class="rack-unit-content">
              {% for device in devices %}
                {% if device.rack_position == u %}
                <div class="rack-device" data-device-id="{{ device.pk }}" data-device-name="{{ device.name }}">
                  <div class="rack-device-name">{{ device.name }}</div>
                  <div class="rack-device-type">{{ device.get_device_type_display }}</div>
                  <button type="button" class="rack-device-remove" onclick="removeDeviceFromRack({{ device.pk }})" title="Remove device">×</button>
                </div>
                {% endif %}
              {% endfor %}
              {% if u not in devices_by_position %}
                <div class="rack-unit-empty" onclick="addDeviceAtPosition({{ u }})" title="Click to add device at U{{ u }}">
                  <span class="rack-unit-empty-text">Empty</span>
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Devices Tab -->
    <div class="rack-tab-panel" id="tab-devices">
      <div class="rack-section-header">
        <h2>Devices in Rack</h2>
        <button type="button" class="form-btn form-btn-primary form-btn--narrow" onclick="addDeviceToRack()">Add Device</button>
      </div>
      {% if devices %}
      <div class="admin-table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Position (U)</th>
              <th>Name</th>
              <th>Type</th>
              <th>Manufacturer</th>
              <th>Model</th>
              <th>IP Address</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for device in devices %}
            <tr>
              <td>{% if device.rack_position %}U{{ device.rack_position }}{% else %}—{% endif %}</td>
              <td><strong>{{ device.name }}</strong></td>
              <td>{{ device.get_device_type_display }}</td>
              <td>{{ device.manufacturer|default:"—" }}</td>
              <td>{{ device.model|default:"—" }}</td>
              <td><code>{{ device.ip_address|default:"—" }}</code></td>
              <td>
                <button type="button" class="admin-btn-sm" onclick="editDevice({{ device.pk }})">Edit</button>
                <button type="button" class="admin-btn-sm" onclick="removeDeviceFromRack({{ device.pk }})">Remove</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="muted">No devices in this rack.</p>
      {% endif %}
    </div>

    <!-- Seals Tab -->
    <div class="rack-tab-panel" id="tab-seals">
      <div class="rack-section-header">
        <h2>Seals</h2>
        <a href="{% url 'admin_app:admin_rack_seal_add' facility.slug rack.pk %}" class="form-btn form-btn-primary form-btn--narrow">Add Seal</a>
      </div>
      
      <!-- Active Seals -->
      {% if active_seals %}
      <div class="rack-seals-section">
        <h3>Active Seals</h3>
        <div class="admin-table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Seal ID</th>
                <th>Location</th>
                <th>Installed By</th>
                <th>Installed At</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for seal in active_seals %}
              <tr>
                <td><strong>{{ seal.seal_id }}</strong></td>
                <td>{{ seal.location_description|default:"—" }}</td>
                <td>{% if seal.installed_by %}{{ seal.installed_by.get_full_name|default:seal.installed_by.username }}{% else %}—{% endif %}</td>
                <td>{{ seal.installed_at|date:"Y-m-d H:i" }}</td>
                <td>
                  <a href="{% url 'admin_app:admin_rack_seal_remove' facility.slug rack.pk seal.pk %}" class="admin-btn-sm admin-btn-danger">Remove</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- Removed Seals -->
      {% if all_seals %}
      <div class="rack-seals-section" style="margin-top: 32px;">
        <h3>Seal History</h3>
        <div class="admin-table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Seal ID</th>
                <th>Location</th>
                <th>Installed By</th>
                <th>Installed At</th>
                <th>Removed By</th>
                <th>Removed At</th>
                <th>Reason</th>
              </tr>
            </thead>
            <tbody>
              {% for seal in all_seals %}
              <tr class="{% if seal.removed_at %}rack-seal-removed{% endif %}">
                <td><strong>{{ seal.seal_id }}</strong></td>
                <td>{{ seal.location_description|default:"—" }}</td>
                <td>{% if seal.installed_by %}{{ seal.installed_by.get_full_name|default:seal.installed_by.username }}{% else %}—{% endif %}</td>
                <td>{{ seal.installed_at|date:"Y-m-d H:i" }}</td>
                <td>{% if seal.removed_by %}{{ seal.removed_by.get_full_name|default:seal.removed_by.username }}{% else %}—{% endif %}</td>
                <td>{% if seal.removed_at %}{{ seal.removed_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}</td>
                <td>{% if seal.removal_reason %}{{ seal.get_removal_reason_display }}{% else %}—{% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      {% if not active_seals and not all_seals %}
      <p class="muted">No seals configured for this rack.</p>
      {% endif %}
    </div>

  </div>
</div>

<script>
(function() {
  // Tab switching
  const tabs = document.querySelectorAll('.rack-tab');
  const panels = document.querySelectorAll('.rack-tab-panel');
  const tabIds = ['visual', 'devices', 'seals'];

  function activateTab(targetTab) {
    if (!tabIds.includes(targetTab)) return;
    tabs.forEach(t => t.classList.remove('active'));
    panels.forEach(p => p.classList.remove('active'));
    const tabEl = document.querySelector('.rack-tab[data-tab="' + targetTab + '"]');
    const panelEl = document.getElementById('tab-' + targetTab);
    if (tabEl) tabEl.classList.add('active');
    if (panelEl) panelEl.classList.add('active');
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      activateTab(this.dataset.tab);
    });
  });

  // On load: if URL has #seals or #devices etc., open that tab
  const hash = (window.location.hash || '').replace(/^#/, '');
  if (hash) activateTab(hash);

  // Add device to rack
  window.addDeviceToRack = function() {
    window.location.href = "{% url 'admin_app:admin_network_device_add_to_rack' facility.slug rack.pk %}";
  };

  window.addDeviceAtPosition = function(uPosition) {
    window.location.href = "{% url 'admin_app:admin_network_device_add_to_position' facility.slug rack.pk 0 %}".replace('/0/', '/' + uPosition + '/');
  };

  window.removeDeviceFromRack = function(deviceId) {
    if (confirm('Remove this device from the rack? The device will remain in the facility but will no longer be assigned to this rack.')) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = "{% url 'admin_app:admin_network_device_remove_from_rack' facility.slug rack.pk 0 %}".replace('/0/', '/' + deviceId + '/');
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
      if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
      }
      document.body.appendChild(form);
      form.submit();
    }
  };

  window.editDevice = function(deviceId) {
    window.location.href = "{% url 'admin_app:admin_network_device_edit' facility.slug 0 %}".replace('/0/', '/' + deviceId + '/');
  };
})();
</script>

<style>
.rack-tab-panel {
  display: none;
}

.rack-tab-panel.active {
  display: block;
}

.rack-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.rack-visual-container {
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 24px;
}

.rack-visual-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.rack-visual {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.rack-unit {
  display: flex;
  align-items: stretch;
  border: 1px solid var(--line);
  background: var(--bg);
  min-height: 40px;
}

.rack-unit-number {
  width: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--btn);
  border-right: 1px solid var(--line);
  font-weight: 600;
  font-size: 12px;
  color: var(--muted);
}

.rack-unit-content {
  flex: 1;
  padding: 8px 12px;
  display: flex;
  align-items: center;
}

.rack-unit-empty {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
  border-radius: 4px;
}

.rack-unit-empty:hover {
  background: var(--btn);
}

.rack-unit-empty-text {
  color: var(--muted);
  font-size: 12px;
}

.rack-device {
  width: 100%;
  padding: 8px 12px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 6px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.rack-device-name {
  font-weight: 600;
  font-size: 14px;
}

.rack-device-type {
  font-size: 12px;
  color: var(--muted);
  margin-left: 12px;
}

.rack-device-remove {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  border-radius: 4px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  padding: 0;
}

.rack-device-remove:hover {
  background: rgba(239, 68, 68, 0.2);
}

.rack-seals-section {
  margin-bottom: 32px;
}

.rack-seals-section h3 {
  margin: 0 0 16px 0;
  font-size: 18px;
  font-weight: 600;
}

.rack-seal-removed {
  opacity: 0.6;
}
</style>
{% endblock %}
