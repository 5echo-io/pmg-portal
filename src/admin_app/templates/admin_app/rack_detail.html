{% extends "admin_app/base.html" %}
{% load static %}

{% block admin_title %}{{ rack.name }}{% endblock %}
{% block breadcrumb_back %}<a href="{% url 'admin_app:admin_facility_detail' facility.slug %}" class="breadcrumb-back-btn" aria-label="Back to {{ facility.name }}">← {{ facility.name }}</a>{% endblock %}
{% block breadcrumb_extra %}
<span class="breadcrumb-sep">→</span> <a href="{% url 'admin_app:admin_facility_list' %}">Facilities</a>
<span class="breadcrumb-sep">→</span> <a href="{% url 'admin_app:admin_facility_detail' facility.slug %}">{{ facility.name }}</a>
<span class="breadcrumb-sep">→</span> <span>{{ rack.name }}</span>
{% endblock %}

{% block admin_content %}
{% csrf_token %}
<div class="rack-detail-container">
  <div class="rack-detail-layout">
    <!-- Left: visualization + info card (same height) + side menu -->
    <aside class="rack-detail-left">
      <div class="rack-detail-left-top">
        <!-- Rack visualization (no box, on the page) -->
        <div class="rack-detail-visual" style="min-height: {% widthratio rack.height_units 1 42 %}px;">
          <div class="rack-visual">
            {% for u in u_positions %}
            <div class="rack-unit" data-u="{{ u }}">
              <div class="rack-unit-number">{{ u }}</div>
              <div class="rack-unit-content">
                {% for device in devices %}
                  {% if device.rack_position == u %}
                  <div class="rack-device" data-device-id="{{ device.pk }}" data-device-name="{{ device.name }}">
                    <div class="rack-device-name">{{ device.name }}</div>
                    <div class="rack-device-type">{{ device.get_device_type_display }}</div>
                    <button type="button" class="rack-device-remove" onclick="removeDeviceFromRack({{ device.pk }})" title="Remove device">×</button>
                  </div>
                  {% endif %}
                {% endfor %}
                {% if u not in devices_by_position %}
                  <div class="rack-unit-empty" onclick="addDeviceAtPosition({{ u }})" title="Click to add device at U{{ u }}">
                    <span class="rack-unit-empty-text">Empty</span>
                  </div>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Rack info card (same height as visual) -->
        <div class="rack-detail-card customer-card-header">
          <div class="customer-card-logo-section">
            <div class="customer-logo-upload-area rack-card-icon-wrap" style="cursor: default;">
              <div class="customer-logo-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect>
                  <line x1="8" y1="2" x2="8" y2="22"></line>
                  <line x1="16" y1="2" x2="16" y2="22"></line>
                  <line x1="2" y1="8" x2="22" y2="8"></line>
                  <line x1="2" y1="16" x2="22" y2="16"></line>
                </svg>
                <span>Rack</span>
              </div>
            </div>
          </div>
          <div class="customer-card-info rack-detail-card-info">
            <div class="customer-card-name-wrapper">
              <h1 class="customer-card-name">{{ rack.name }}</h1>
              <div class="rack-detail-card-actions">
                <span class="rack-detail-badge rack-detail-badge--{% if rack.is_active %}active{% else %}inactive{% endif %}">{% if rack.is_active %}Active{% else %}Inactive{% endif %}</span>
                <a href="{% url 'admin_app:admin_rack_edit' facility.slug rack.pk %}?modal=1" class="customer-card-icon-btn customer-card-icon-btn--edit rack-edit-modal-btn" title="Edit Rack">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </a>
                <a href="{% url 'admin_app:admin_rack_seal_add' facility.slug rack.pk %}" class="customer-card-icon-btn rack-detail-add-seal-btn" title="Add Seal">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14M5 12h14"></path>
                  </svg>
                </a>
              </div>
            </div>
            <p class="customer-card-meta">Created {{ rack.created_at|date:"M j, Y" }} · Updated {{ rack.updated_at|date:"M j, Y" }}</p>
            <div class="rack-detail-card-meta-block">
              <span class="rack-detail-meta-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2"/></svg>
                {{ rack.height_units }}U
              </span>
              {% if rack.location %}
              <span class="rack-detail-meta-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                {{ rack.location }}
              </span>
              {% endif %}
              {% if rack.serial_number %}
              <span class="rack-detail-meta-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01"/></svg>
                {{ rack.serial_number }}
              </span>
              {% endif %}
            </div>
            {% if rack.description %}
            <p class="customer-card-org" style="white-space: pre-wrap;">{{ rack.description }}</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Minimal side menu -->
      <nav class="rack-detail-sidemenu" aria-label="Rack sections">
        <button type="button" class="rack-sidemenu-item active" data-tab="visual">Visual Rack</button>
        <button type="button" class="rack-sidemenu-item" data-tab="devices">Devices ({{ devices|length }})</button>
        <button type="button" class="rack-sidemenu-item" data-tab="seals">Seals ({{ active_seals|length }})</button>
      </nav>
    </aside>

    <!-- Right: tab content -->
    <main class="rack-detail-main">
      <div class="rack-tab-panel active" id="tab-visual">
        <div class="rack-section-header">
          <h2>Rack Front View - {{ rack.height_units }}U</h2>
          <button type="button" class="form-btn form-btn-primary form-btn--narrow" onclick="addDeviceToRack()">Add Device</button>
        </div>
        <div class="rack-visual-container rack-visual-container--inline">
          <div class="rack-visual">
            {% for u in u_positions %}
            <div class="rack-unit" data-u="{{ u }}">
              <div class="rack-unit-number">{{ u }}</div>
              <div class="rack-unit-content">
                {% for device in devices %}
                  {% if device.rack_position == u %}
                  <div class="rack-device" data-device-id="{{ device.pk }}" data-device-name="{{ device.name }}">
                    <div class="rack-device-name">{{ device.name }}</div>
                    <div class="rack-device-type">{{ device.get_device_type_display }}</div>
                    <button type="button" class="rack-device-remove" onclick="removeDeviceFromRack({{ device.pk }})" title="Remove device">×</button>
                  </div>
                  {% endif %}
                {% endfor %}
                {% if u not in devices_by_position %}
                  <div class="rack-unit-empty" onclick="addDeviceAtPosition({{ u }})" title="Click to add device at U{{ u }}">
                    <span class="rack-unit-empty-text">Empty</span>
                  </div>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="rack-tab-panel" id="tab-devices">
        <div class="rack-section-header">
          <h2>Devices in Rack</h2>
          <button type="button" class="form-btn form-btn-primary form-btn--narrow" onclick="addDeviceToRack()">Add Device</button>
        </div>
        {% if devices %}
        <div class="admin-table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Position (U)</th>
                <th>Name</th>
                <th>Type</th>
                <th>Manufacturer</th>
                <th>Model</th>
                <th>IP Address</th>
                <th class="admin-table-actions"></th>
              </tr>
            </thead>
            <tbody>
              {% for device in devices %}
              <tr>
                <td>{% if device.rack_position %}U{{ device.rack_position }}{% else %}—{% endif %}</td>
                <td><strong>{{ device.name }}</strong></td>
                <td>{{ device.get_device_type_display }}</td>
                <td>{{ device.manufacturer|default:"—" }}</td>
                <td>{{ device.model|default:"—" }}</td>
                <td><code>{{ device.ip_address|default:"—" }}</code></td>
                <td class="admin-table-actions">
                  <button type="button" class="admin-btn-sm" onclick="editDevice({{ device.pk }})">Edit</button>
                  <button type="button" class="admin-btn-sm admin-btn-danger" onclick="removeDeviceFromRack({{ device.pk }})">Remove</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="muted">No devices in this rack.</p>
        {% endif %}
      </div>

      <div class="rack-tab-panel" id="tab-seals">
        <div class="rack-section-header">
          <h2>Seals</h2>
          <a href="{% url 'admin_app:admin_rack_seal_add' facility.slug rack.pk %}" class="form-btn form-btn-primary form-btn--narrow">Add Seal</a>
        </div>

        {% if active_seals %}
        <div class="rack-seals-section">
          <h3>Active Seals</h3>
          <div class="admin-table-wrap">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Seal ID</th>
                  <th>Location</th>
                  <th>Installed By</th>
                  <th>Installed At</th>
                  <th class="admin-table-actions"></th>
                </tr>
              </thead>
              <tbody>
                {% for seal in active_seals %}
                <tr>
                  <td><strong>{{ seal.seal_id }}</strong></td>
                  <td>{{ seal.location_description|default:"—" }}</td>
                  <td>{% if seal.installed_by %}{{ seal.installed_by.get_full_name|default:seal.installed_by.username }}{% else %}—{% endif %}</td>
                  <td>{{ seal.installed_at|date:"Y-m-d H:i" }}</td>
                  <td class="admin-table-actions">
                    <a href="{% url 'admin_app:admin_rack_seal_remove' facility.slug rack.pk seal.pk %}" class="admin-btn-sm admin-btn-danger">Remove</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        {% if all_seals %}
        <div class="rack-seals-section" style="margin-top: 32px;">
          <h3>Seal History</h3>
          <div class="admin-table-wrap">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Seal ID</th>
                  <th>Location</th>
                  <th>Installed By</th>
                  <th>Installed At</th>
                  <th>Removed By</th>
                  <th>Removed At</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody>
                {% for seal in all_seals %}
                <tr class="{% if seal.removed_at %}rack-seal-removed{% endif %}">
                  <td><strong>{{ seal.seal_id }}</strong></td>
                  <td>{{ seal.location_description|default:"—" }}</td>
                  <td>{% if seal.installed_by %}{{ seal.installed_by.get_full_name|default:seal.installed_by.username }}{% else %}—{% endif %}</td>
                  <td>{{ seal.installed_at|date:"Y-m-d H:i" }}</td>
                  <td>{% if seal.removed_by %}{{ seal.removed_by.get_full_name|default:seal.removed_by.username }}{% else %}—{% endif %}</td>
                  <td>{% if seal.removed_at %}{{ seal.removed_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}</td>
                  <td>{% if seal.removal_reason %}{{ seal.get_removal_reason_display }}{% else %}—{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}

        {% if not active_seals and not all_seals %}
        <p class="muted">No seals configured for this rack.</p>
        {% endif %}
      </div>
    </main>
  </div>
</div>

<!-- Edit Rack modal -->
<div id="rack-edit-modal" class="rack-modal" aria-hidden="true">
  <div class="rack-modal-backdrop"></div>
  <div class="rack-modal-dialog">
    <div class="rack-modal-header">
      <h2 class="rack-modal-title">Edit Rack</h2>
      <button type="button" class="rack-modal-close" aria-label="Close">&times;</button>
    </div>
    <iframe id="rack-edit-iframe" class="rack-modal-iframe" title="Edit Rack"></iframe>
  </div>
</div>

<script>
(function() {
  const tabIds = ['visual', 'devices', 'seals'];
  const sidemenuItems = document.querySelectorAll('.rack-sidemenu-item');
  const panels = document.querySelectorAll('.rack-detail-main .rack-tab-panel');

  function activateTab(targetTab) {
    if (!tabIds.includes(targetTab)) return;
    sidemenuItems.forEach(el => {
      el.classList.toggle('active', el.dataset.tab === targetTab);
    });
    panels.forEach(p => {
      p.classList.toggle('active', p.id === 'tab-' + targetTab);
    });
  }

  sidemenuItems.forEach(item => {
    item.addEventListener('click', function() {
      activateTab(this.dataset.tab);
    });
  });

  const hash = (window.location.hash || '').replace(/^#/, '');
  if (hash) activateTab(hash);

  // Edit modal
  const modal = document.getElementById('rack-edit-modal');
  const iframe = document.getElementById('rack-edit-iframe');
  const editBtn = document.querySelector('.rack-edit-modal-btn');
  const closeBtn = modal && modal.querySelector('.rack-modal-close');
  const backdrop = modal && modal.querySelector('.rack-modal-backdrop');

  if (editBtn && modal && iframe) {
    editBtn.addEventListener('click', function(e) {
      e.preventDefault();
      iframe.src = this.getAttribute('href');
      modal.setAttribute('aria-hidden', 'false');
      modal.classList.add('rack-modal-open');
    });
  }
  function closeModal() {
    if (!modal) return;
    modal.setAttribute('aria-hidden', 'true');
    modal.classList.remove('rack-modal-open');
    iframe.src = 'about:blank';
  }
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (backdrop) backdrop.addEventListener('click', closeModal);

  window.addEventListener('message', function(e) {
    if (e.data && e.data.type === 'pmg-rack-edit-saved') {
      closeModal();
      window.location.reload();
    }
  });

  // When iframe loads rack detail with modal_close=1, tell parent to close and refresh
  if (window.self !== window.top && new URLSearchParams(window.location.search).get('modal_close')) {
    try { window.parent.postMessage({ type: 'pmg-rack-edit-saved' }, '*'); } catch (err) {}
  }

  window.addDeviceToRack = function() {
    window.location.href = "{% url 'admin_app:admin_network_device_add_to_rack' facility.slug rack.pk %}";
  };
  window.addDeviceAtPosition = function(uPosition) {
    window.location.href = "{% url 'admin_app:admin_network_device_add_to_position' facility.slug rack.pk 0 %}".replace('/0/', '/' + uPosition + '/');
  };
  window.removeDeviceFromRack = function(deviceId) {
    if (confirm('Remove this device from the rack? The device will remain in the facility but will no longer be assigned to this rack.')) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = "{% url 'admin_app:admin_network_device_remove_from_rack' facility.slug rack.pk 0 %}".replace('/0/', '/' + deviceId + '/');
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
      if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken.value;
        form.appendChild(csrfInput);
      }
      document.body.appendChild(form);
      form.submit();
    }
  };
  window.editDevice = function(deviceId) {
    window.location.href = "{% url 'admin_app:admin_network_device_edit' facility.slug 0 %}".replace('/0/', '/' + deviceId + '/');
  };
})();
</script>

<style>
.rack-detail-layout {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 32px;
  align-items: start;
}
@media (max-width: 900px) {
  .rack-detail-layout {
    grid-template-columns: 1fr;
  }
}

.rack-detail-left {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.rack-detail-left-top {
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-height: 280px;
}
.rack-detail-visual {
  flex: 1;
  min-height: 120px;
  border: 1px solid var(--line);
  border-radius: 12px;
  background: var(--bg);
  overflow: hidden;
}
.rack-detail-card {
  flex: 1;
  min-height: 180px;
  margin-bottom: 0;
}

.rack-detail-card-info {
  flex: 1;
  display: flex;
  flex-direction: column;
}
.rack-detail-card-info .customer-card-name-wrapper {
  flex-direction: column;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 12px;
}
.rack-detail-card-info .customer-card-name {
  margin: 0;
  font-size: 20px;
}
.rack-detail-card-actions {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.rack-detail-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 32px;
  min-height: 32px;
  padding: 0 12px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  border-radius: 8px;
  border: 1px solid transparent;
}
.rack-detail-badge--active {
  background: rgba(34, 197, 94, 0.15);
  color: #16a34a;
}
.rack-detail-badge--inactive {
  background: rgba(148, 163, 184, 0.2);
  color: var(--muted);
}
.rack-detail-add-seal-btn {
  color: var(--text);
}
.rack-detail-add-seal-btn:hover {
  background: rgba(16, 185, 129, 0.15);
  border-color: rgba(16, 185, 129, 0.4);
  color: #10b981;
}
.rack-detail-card-meta-block {
  margin-top: 20px;
  padding-top: 16px;
  border-top: 1px solid var(--line);
  display: flex;
  flex-wrap: wrap;
  gap: 12px 20px;
}
.rack-detail-meta-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--muted);
}
.rack-detail-meta-item svg {
  flex-shrink: 0;
  opacity: 0.8;
}

.rack-detail-sidemenu {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.rack-sidemenu-item {
  display: block;
  width: 100%;
  padding: 10px 14px;
  text-align: left;
  font-size: 13px;
  font-weight: 500;
  color: var(--muted);
  background: transparent;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
}
.rack-sidemenu-item:hover {
  color: var(--text);
  background: rgba(255, 255, 255, 0.04);
}
.rack-sidemenu-item.active {
  color: #3b82f6;
  background: rgba(59, 130, 246, 0.1);
}

.rack-detail-main {
  min-width: 0;
}
.rack-detail-main .rack-tab-panel {
  display: none;
}
.rack-detail-main .rack-tab-panel.active {
  display: block;
}

.rack-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.rack-section-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.rack-visual-container--inline {
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 24px;
}
.rack-visual {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.rack-unit {
  display: flex;
  align-items: stretch;
  border: 1px solid var(--line);
  background: var(--bg);
  min-height: 40px;
}
.rack-unit-number {
  width: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--btn);
  border-right: 1px solid var(--line);
  font-weight: 600;
  font-size: 12px;
  color: var(--muted);
}
.rack-unit-content {
  flex: 1;
  padding: 8px 12px;
  display: flex;
  align-items: center;
}
.rack-unit-empty {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s;
  border-radius: 4px;
}
.rack-unit-empty:hover {
  background: var(--btn);
}
.rack-unit-empty-text {
  color: var(--muted);
  font-size: 12px;
}
.rack-device {
  width: 100%;
  padding: 8px 12px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.rack-device-name { font-weight: 600; font-size: 14px; }
.rack-device-type { font-size: 12px; color: var(--muted); margin-left: 12px; }
.rack-device-remove {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  border-radius: 4px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  padding: 0;
}
.rack-device-remove:hover {
  background: rgba(239, 68, 68, 0.2);
}

.rack-seals-section { margin-bottom: 32px; }
.rack-seals-section h3 { margin: 0 0 16px 0; font-size: 18px; font-weight: 600; }
.rack-seal-removed { opacity: 0.6; }

/* Modal */
.rack-modal {
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
}
.rack-modal-open {
  opacity: 1;
  visibility: visible;
}
.rack-modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
}
.rack-modal-dialog {
  position: relative;
  width: 100%;
  max-width: 560px;
  max-height: 90vh;
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 12px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}
.rack-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--line);
  flex-shrink: 0;
}
.rack-modal-title { margin: 0; font-size: 16px; font-weight: 600; }
.rack-modal-close {
  background: none;
  border: none;
  font-size: 24px;
  line-height: 1;
  color: var(--muted);
  cursor: pointer;
  padding: 4px;
}
.rack-modal-close:hover { color: var(--text); }
.rack-modal-iframe {
  flex: 1;
  min-height: 400px;
  border: none;
  width: 100%;
}
</style>
{% endblock %}
