{% extends "admin_app/base.html" %}
{% load static %}

{% block admin_title %}{{ customer.name }}{% endblock %}
{% block breadcrumb_extra %}
<span class="breadcrumb-sep">→</span> <a href="{% url 'admin_app:admin_customer_list' %}">Customers</a>
<span class="breadcrumb-sep">→</span> <span>{{ customer.name }}</span>
{% endblock %}

{% block admin_content %}
{% csrf_token %}
<div class="customer-card-container">
  <!-- Header Section -->
  <div class="customer-card-header">
    <div class="customer-card-logo-section">
      <div class="customer-logo-upload-area" id="logo-upload-area">
        {% if customer.logo_url %}
        <div class="customer-logo-preview-wrapper">
          <img src="{{ customer.logo_url }}" alt="{{ customer.name }} logo" class="customer-logo-preview" id="logo-preview" />
          <button type="button" class="logo-delete-btn" id="logo-delete-btn" title="Delete logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
          </button>
        </div>
        {% else %}
        <div class="customer-logo-placeholder" id="logo-placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <path d="M21 15l-5-5L5 21"></path>
          </svg>
          <span>Upload logo</span>
        </div>
        {% endif %}
        <input type="file" id="logo-file-input" accept="image/*" style="display: none;" />
      </div>
      <div class="customer-logo-upload-info">
        <p class="muted">Click to upload or change logo</p>
        <p class="muted" style="font-size: 11px;">Recommended: 200x200px, PNG or JPG</p>
      </div>
    </div>
    
    <div class="customer-card-info">
      <div class="customer-card-name-wrapper">
        <h1 class="customer-card-name">{{ customer.name }}</h1>
        <div class="customer-card-header-actions">
          <a href="{% url 'admin_app:admin_customer_edit' customer.pk %}" class="customer-card-icon-btn customer-card-icon-btn--edit" title="Edit Details">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </a>
          <button type="button" class="customer-card-icon-btn customer-card-icon-btn--delete" data-delete-url="{% url 'admin_app:admin_customer_delete' customer.pk %}" data-delete-message="Are you sure you want to delete the customer '{{ customer.name }}'? This will also delete all memberships and portal links associated with this customer." title="Delete Customer">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </div>
      {% if customer.org_number %}
      <p class="customer-card-org">Org. no.: {{ customer.org_number }}</p>
      {% endif %}
      {% if customer.primary_contact %}
      <p class="customer-card-contact">Primary contact: {{ customer.primary_contact.get_full_name|default:customer.primary_contact.email }}</p>
      {% endif %}
    </div>
  </div>

  <!-- Tabs Section -->
  <div class="customer-card-tabs">
    <button class="customer-tab active" data-tab="members">Members ({{ memberships|length }})</button>
    <button class="customer-tab" data-tab="links">Portal Links ({{ portal_links|length }})</button>
    <button class="customer-tab" data-tab="info">Information</button>
  </div>

  <!-- Tab Content -->
  <div class="customer-card-content">
    <!-- Members Tab -->
    <div class="customer-tab-panel active" id="tab-members">
      <div class="customer-section-header">
        <h2>Customer Members</h2>
        <a href="{% url 'admin_app:admin_customer_access_add' %}?customer={{ customer.pk }}&redirect_to=admin_app:admin_customer_detail" class="form-btn form-btn-primary form-btn--narrow">Add Member</a>
      </div>
      {% if memberships %}
      <div class="admin-table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Email</th>
              <th>Role</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for membership in memberships %}
            <tr>
              <td>{{ membership.user.get_full_name|default:membership.user.username }}</td>
              <td>{{ membership.user.email }}</td>
              <td>
                <span class="role-badge role-badge--{{ membership.role }}">
                  {{ membership.get_role_display }}
                </span>
              </td>
              <td>
                <a href="{% url 'admin_app:admin_customer_access_edit' membership.pk %}?customer={{ customer.pk }}&redirect_to=admin_app:admin_customer_detail" class="admin-btn-sm">Edit</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="muted">No members assigned to this customer.</p>
      {% endif %}
    </div>

    <!-- Links Tab -->
    <div class="customer-tab-panel" id="tab-links">
      <div class="customer-section-header">
        <h2>Portal Links</h2>
        <a href="{% url 'admin_app:admin_portal_link_add' %}?customer={{ customer.pk }}&redirect_to=admin_app:admin_customer_detail" class="form-btn form-btn-primary form-btn--narrow">Add Link</a>
      </div>
      {% if portal_links %}
      <div class="admin-table-wrap">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Title</th>
              <th>URL</th>
              <th>Description</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for link in portal_links %}
            <tr>
              <td>{{ link.title }}</td>
              <td><a href="{{ link.url }}" target="_blank" rel="noopener">{{ link.url|truncatechars:40 }}</a></td>
              <td>{{ link.description|default:"—" }}</td>
              <td>
                <a href="{% url 'admin_app:admin_portal_link_edit' link.pk %}?customer={{ customer.pk }}&redirect_to=admin_app:admin_customer_detail" class="admin-btn-sm">Edit</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="muted">No portal links configured for this customer.</p>
      {% endif %}
    </div>

    <!-- Information Tab -->
    <div class="customer-tab-panel" id="tab-info">
      <div class="customer-info-grid">
        <div class="customer-info-item">
          <label>Name</label>
          <p>{{ customer.name }}</p>
        </div>
        <div class="customer-info-item">
          <label>Slug</label>
          <p><code>{{ customer.slug }}</code></p>
        </div>
        {% if customer.org_number %}
        <div class="customer-info-item">
          <label>Organization Number</label>
          <p>{{ customer.org_number }}</p>
        </div>
        {% endif %}
        {% if customer.primary_contact %}
        <div class="customer-info-item">
          <label>Primary Contact</label>
          <p>{{ customer.primary_contact.get_full_name|default:customer.primary_contact.username }} ({{ customer.primary_contact.email }})</p>
        </div>
        {% endif %}
        {% if customer.contact_info %}
        <div class="customer-info-item customer-info-item--full">
          <label>Contact Information</label>
          <p style="white-space: pre-wrap;">{{ customer.contact_info }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const uploadArea = document.getElementById('logo-upload-area');
  const fileInput = document.getElementById('logo-file-input');
  const logoPreview = document.getElementById('logo-preview');
  const logoPlaceholder = document.getElementById('logo-placeholder');
  const deleteBtn = document.getElementById('logo-delete-btn');
  const customerId = {{ customer.pk }};
  
  // Upload area click handler
  if (uploadArea) {
    uploadArea.addEventListener('click', function(e) {
      if (e.target !== deleteBtn && !deleteBtn?.contains(e.target)) {
        fileInput?.click();
      }
    });
  }
  
  // File input change handler
  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file.');
        return;
      }
      
      // Show preview immediately
      const reader = new FileReader();
      reader.onload = function(e) {
        if (logoPlaceholder) logoPlaceholder.style.display = 'none';
        if (!logoPreview) {
          const wrapper = document.createElement('div');
          wrapper.className = 'customer-logo-preview-wrapper';
          wrapper.innerHTML = '<img src="' + e.target.result + '" class="customer-logo-preview" id="logo-preview" /><button type="button" class="logo-delete-btn" id="logo-delete-btn" title="Delete logo"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button>';
          uploadArea.appendChild(wrapper);
        } else {
          logoPreview.src = e.target.result;
        }
      };
      reader.readAsDataURL(file);
      
      // Upload file
      const formData = new FormData();
      formData.append('logo', file);
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
      formData.append('csrfmiddlewaretoken', csrfToken);
      
      fetch('/admin/customers/' + customerId + '/logo/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.logo_url) {
          // Hide placeholder if exists
          if (logoPlaceholder) logoPlaceholder.style.display = 'none';
          
          // Create or update preview
          let previewWrapper = document.querySelector('.customer-logo-preview-wrapper');
          if (!previewWrapper) {
            previewWrapper = document.createElement('div');
            previewWrapper.className = 'customer-logo-preview-wrapper';
            uploadArea.appendChild(previewWrapper);
          }
          
          // Create or update image
          let img = previewWrapper.querySelector('.customer-logo-preview');
          if (!img) {
            img = document.createElement('img');
            img.className = 'customer-logo-preview';
            img.id = 'logo-preview';
            previewWrapper.appendChild(img);
            
            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'logo-delete-btn';
            deleteBtn.id = 'logo-delete-btn';
            deleteBtn.title = 'Delete logo';
            deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>';
            previewWrapper.appendChild(deleteBtn);
            
            // Re-attach delete button handler
            deleteBtn.addEventListener('click', function(e) {
              e.stopPropagation();
              if (!confirm('Are you sure you want to delete this logo?')) return;
              
              const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
              fetch('/admin/customers/' + customerId + '/logo/delete/', {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrfToken,
                  'Content-Type': 'application/json'
                }
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  previewWrapper.remove();
                  if (logoPlaceholder) logoPlaceholder.style.display = 'flex';
                  if (fileInput) fileInput.value = '';
                } else {
                  alert('Error deleting logo: ' + (data.error || 'Unknown error'));
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('Error deleting logo. Please try again.');
              });
            });
          }
          
          // Update image source with cache busting
          img.src = data.logo_url + '?t=' + new Date().getTime();
        } else {
          alert('Error uploading logo: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error uploading logo. Please try again.');
      });
    });
  }
  
  // Delete button handler
  if (deleteBtn) {
    deleteBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (!confirm('Are you sure you want to delete this logo?')) return;
      
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
      fetch('/admin/customers/' + customerId + '/logo/delete/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const wrapper = deleteBtn.closest('.customer-logo-preview-wrapper');
          if (wrapper) wrapper.remove();
          if (logoPlaceholder) logoPlaceholder.style.display = 'flex';
          if (fileInput) fileInput.value = '';
        } else {
          alert('Error deleting logo: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error deleting logo. Please try again.');
      });
    });
  }
  
  // Tab switching
  const tabs = document.querySelectorAll('.customer-tab');
  const panels = document.querySelectorAll('.customer-tab-panel');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const targetTab = this.dataset.tab;
      
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      
      this.classList.add('active');
      document.getElementById('tab-' + targetTab)?.classList.add('active');
    });
  });
})();
</script>
{% endblock %}
