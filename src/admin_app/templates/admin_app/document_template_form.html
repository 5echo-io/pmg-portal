{% extends "admin_app/base.html" %}
{% load i18n %}

{% block admin_title %}{% if template %}{% trans "Edit template" %}: {{ template.name }}{% else %}{% trans "Add document template" %}{% endif %}{% endblock %}
{% block breadcrumb_back %}<a href="{% url 'admin_app:admin_document_template_list' %}" class="breadcrumb-back-btn" aria-label="Back to Document templates">← {% trans "Document templates" %}</a>{% endblock %}
{% block breadcrumb_extra %}
<span class="breadcrumb-sep">→</span> <a href="{% url 'admin_app:admin_document_template_list' %}">{% trans "Document templates" %}</a>
<span class="breadcrumb-sep">→</span> <span>{% if template %}{% trans "Edit" %}{% else %}{% trans "Add" %}{% endif %}</span>
{% endblock %}

{% block admin_content %}
<h1 class="admin-page-title">{% if template %}{% trans "Edit template" %}: {{ template.name }}{% else %}{% trans "Add document template" %}{% endif %}</h1>

<p class="muted" style="margin-bottom: 1rem;">{% trans "Document type links this template to the correct PDF: Servicerapport → service report download; Nettverksdokumentasjon → network documentation. Full CSS is applied when WeasyPrint is available on the server; otherwise a simplified PDF may be generated." %}</p>

<form method="post" action="" class="admin-form admin-form--wide">
  {% csrf_token %}
  <div class="admin-form-field">
    <label for="name">{% trans "Name" %}</label>
    <input type="text" id="name" name="name" value="{{ template.name|default:'' }}" class="form-input" required maxlength="200" placeholder="e.g. Standard servicerapport">
  </div>
  <div class="admin-form-field">
    <label for="document_type">{% trans "Document type" %}</label>
    <select id="document_type" name="document_type" class="form-input" required>
      <option value="servicerapport" {% if template.document_type == 'servicerapport' %}selected{% endif %}>{% trans "Servicerapport" %}</option>
      <option value="nettverksdokumentasjon" {% if template.document_type == 'nettverksdokumentasjon' %}selected{% endif %}>{% trans "Nettverksdokumentasjon" %}</option>
    </select>
    <span class="muted">{% trans "Determines where this template is used (service report PDF vs network documentation PDF)." %}</span>
  </div>
  <div class="admin-form-field">
    <label><input type="checkbox" name="is_default" {% if template.is_default %}checked{% endif %}> {% trans "Use as default for this document type" %}</label>
  </div>
  <div class="admin-form-field">
    <label for="variables_help">{% trans "Variables help (optional)" %}</label>
    <textarea id="variables_help" name="variables_help" class="form-input" rows="4" placeholder="List of available variables for reference, e.g. service_log.service_id, facility.name, customer.name">{{ template.variables_help|default:'' }}</textarea>
  </div>
  <div class="admin-form-field">
    <label for="html_content">{% trans "HTML content" %} <span class="muted">({% trans "full document, use Django template variables" %})</span></label>
    <textarea id="html_content" name="html_content" class="form-input" rows="24" style="font-family: monospace; font-size: 12px;">{{ template.html_content|default:'' }}</textarea>
  </div>
  <div class="admin-form-field">
    <label for="css_content">{% trans "CSS content" %} <span class="muted">({% trans "WeasyPrint: @page, typography, margins" %})</span></label>
    <textarea id="css_content" name="css_content" class="form-input" rows="16" style="font-family: monospace; font-size: 12px;">{{ template.css_content|default:'' }}</textarea>
  </div>
  <div class="admin-form-actions">
    <button type="submit" class="form-btn form-btn-primary">{% trans "Save" %}</button>
    <a href="{% url 'admin_app:admin_document_template_list' %}" class="form-btn form-btn-secondary">{% trans "Cancel" %}</a>
  </div>
</form>

{% if template %}
<hr style="margin: 2rem 0;">
<h2 class="admin-section-title">{% trans "Preview" %}</h2>
<p class="muted">{% trans "Preview uses sample data. Save the template to refresh the preview." %}</p>
<p>
  <a href="{% url 'admin_app:admin_document_template_preview' template.pk %}" target="_blank" rel="noopener" class="form-btn form-btn-secondary">{% trans "Open preview in new tab" %}</a>
</p>
<div style="border: 1px solid #ccc; background: #f9f9f9; min-height: 400px;">
  <iframe src="{% url 'admin_app:admin_document_template_preview' template.pk %}" title="{% trans 'Document preview' %}" style="width: 100%; height: 600px; border: 0;"></iframe>
</div>
{% endif %}
{% endblock %}
