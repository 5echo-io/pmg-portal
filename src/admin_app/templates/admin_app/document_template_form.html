{% extends "admin_app/base.html" %}
{% load i18n %}

{% block admin_title %}{% if template %}{% trans "Edit template" %}: {{ template.name }}{% else %}{% trans "Add document template" %}{% endif %}{% endblock %}
{% block breadcrumb_back %}<a href="{% url 'admin_app:admin_document_template_list' %}" class="breadcrumb-back-btn" aria-label="Back to Document templates">← {% trans "Document templates" %}</a>{% endblock %}
{% block breadcrumb_extra %}
<span class="breadcrumb-sep">→</span> <a href="{% url 'admin_app:admin_document_template_list' %}">{% trans "Document templates" %}</a>
<span class="breadcrumb-sep">→</span> <span>{% if template %}{% trans "Edit" %}{% else %}{% trans "Add" %}{% endif %}</span>
{% endblock %}

{% block admin_content %}
<h1 class="admin-page-title">{% if template %}{% trans "Edit template" %}: {{ template.name }}{% else %}{% trans "Add document template" %}{% endif %}</h1>

<p class="muted" style="margin-bottom: 1rem;">{% trans "Document type links this template to the correct PDF: Servicerapport → service report download; Nettverksdokumentasjon → network documentation. Full CSS is applied when WeasyPrint is available on the server; otherwise a simplified PDF may be generated." %}</p>

<style>
.document-template-edit-layout { display: grid; grid-template-columns: minmax(0, 6fr) minmax(180px, 4fr); gap: 1.5rem; align-items: start; }
.document-template-preview-col { display: flex; flex-direction: column; gap: 0; }
.doc-preview-toolbar { display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem; margin-bottom: 0.5rem; min-height: 2rem; }
.doc-preview-toolbar .doc-preview-btn { display: inline-flex; align-items: center; justify-content: center; width: 36px; height: 36px; padding: 0; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); color: var(--text-secondary); cursor: pointer; transition: var(--transition); }
.doc-preview-toolbar .doc-preview-btn:hover { background: var(--surface-elevated); color: var(--text-primary); border-color: var(--border-hover); }
.doc-preview-iframe-wrap { border: 1px solid var(--border); background: #fff; overflow: auto; min-height: 300px; }
.doc-preview-iframe-wrap::-webkit-scrollbar { width: 10px; height: 10px; }
.doc-preview-iframe-wrap::-webkit-scrollbar-track { background: var(--bg); }
.doc-preview-iframe-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }
.doc-preview-iframe-wrap::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }
@media (max-width: 900px) {
  .document-template-edit-layout { grid-template-columns: 1fr; }
  .document-template-preview-col { position: static !important; }
}
</style>
<div class="document-template-edit-layout">
  <div class="document-template-form-col">
    <form method="post" action="" class="admin-form admin-form--wide" id="document-template-form">
      {% csrf_token %}
      <div class="admin-form-field">
        <label for="name">{% trans "Name" %}</label>
        <input type="text" id="name" name="name" value="{{ template.name|default:'' }}" class="form-input" required maxlength="200" placeholder="e.g. Standard servicerapport">
      </div>
      <div class="admin-form-field">
        <label for="document_type">{% trans "Document type" %}</label>
        <select id="document_type" name="document_type" class="form-input" required>
          <option value="servicerapport" {% if template.document_type == 'servicerapport' %}selected{% endif %}>{% trans "Servicerapport" %}</option>
          <option value="nettverksdokumentasjon" {% if template.document_type == 'nettverksdokumentasjon' %}selected{% endif %}>{% trans "Nettverksdokumentasjon" %}</option>
        </select>
        <span class="muted">{% trans "Determines where this template is used (service report PDF vs network documentation PDF)." %}</span>
      </div>
      <div class="admin-form-field">
        <label><input type="checkbox" name="is_default" {% if template.is_default %}checked{% endif %}> {% trans "Use as default for this document type" %}</label>
      </div>
      <div class="admin-form-field">
        <label for="variables_help">{% trans "Variables help (optional)" %}</label>
        <textarea id="variables_help" name="variables_help" class="form-input" rows="4" placeholder="List of available variables for reference, e.g. service_log.service_id, facility.name, customer.name">{{ template.variables_help|default:'' }}</textarea>
      </div>
      <div class="admin-form-field">
        <label for="html_content">{% trans "HTML content" %} <span class="muted">({% trans "full document, use Django template variables" %})</span></label>
        <textarea id="html_content" name="html_content" class="form-input doc-preview-source" rows="24" style="font-family: monospace; font-size: 12px;">{{ template.html_content|default:'' }}</textarea>
      </div>
      <div class="admin-form-field">
        <label for="css_content">{% trans "CSS content" %} <span class="muted">({% trans "WeasyPrint: @page, typography, margins" %})</span></label>
        <textarea id="css_content" name="css_content" class="form-input doc-preview-source" rows="16" style="font-family: monospace; font-size: 12px;">{{ template.css_content|default:'' }}</textarea>
      </div>
      <div class="admin-form-actions">
        <button type="submit" class="form-btn form-btn-primary">{% trans "Save" %}</button>
        <a href="{% url 'admin_app:admin_document_template_list' %}" class="form-btn form-btn-secondary">{% trans "Cancel" %}</a>
      </div>
    </form>
  </div>

  <div class="document-template-preview-col" style="position: sticky; top: 1rem;">
    <div class="doc-preview-toolbar">
      <button type="button" id="doc-preview-update-btn" class="doc-preview-btn" title="{% trans 'Update preview' %}" aria-label="{% trans 'Update preview' %}">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
      </button>
      <a href="#" id="doc-preview-newtab-link" class="doc-preview-btn" target="_blank" rel="noopener" title="{% trans 'Open in new tab' %}" aria-label="{% trans 'Open in new tab' %}">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
      </a>
    </div>
    <div class="doc-preview-iframe-wrap">
      <iframe id="doc-preview-iframe" title="{% trans 'Document preview' %}" style="width: 100%; height: 70vh; min-height: 400px; border: 0; display: block; background: #fff;"></iframe>
    </div>
  </div>
</div>

<script>
(function() {
  var form = document.getElementById('document-template-form');
  var iframe = document.getElementById('doc-preview-iframe');
  var updateBtn = document.getElementById('doc-preview-update-btn');
  var newTabLink = document.getElementById('doc-preview-newtab-link');
  var previewDraftUrl = "{% url 'admin_app:admin_document_template_preview_draft' %}";
  var csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
  var debounceMs = 1200;
  var debounceTimer = null;

  function getFormData() {
    return {
      html_content: (document.getElementById('html_content') || {}).value || '',
      css_content: (document.getElementById('css_content') || {}).value || '',
      document_type: (document.getElementById('document_type') || {}).value || 'servicerapport',
      csrfmiddlewaretoken: csrfToken
    };
  }

  function updatePreview() {
    var data = getFormData();
    var body = new FormData();
    body.append('html_content', data.html_content);
    body.append('css_content', data.css_content);
    body.append('document_type', data.document_type);
    body.append('csrfmiddlewaretoken', data.csrfmiddlewaretoken);
    updateBtn.disabled = true;
    updateBtn.setAttribute('aria-busy', 'true');
    fetch(previewDraftUrl, { method: 'POST', body: body, credentials: 'same-origin' })
      .then(function(r) { return r.text(); })
      .then(function(html) {
        iframe.srcdoc = html;
        updateBtn.disabled = false;
        updateBtn.removeAttribute('aria-busy');
      })
      .catch(function() {
        updateBtn.disabled = false;
        updateBtn.removeAttribute('aria-busy');
      });
  }

  function scheduleAutoUpdate() {
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(updatePreview, debounceMs);
  }

  updateBtn.addEventListener('click', function() { updatePreview(); });
  form.querySelectorAll('.doc-preview-source').forEach(function(el) {
    el.addEventListener('input', scheduleAutoUpdate);
    el.addEventListener('change', scheduleAutoUpdate);
  });
  document.getElementById('document_type').addEventListener('change', scheduleAutoUpdate);

  if (newTabLink) {
    newTabLink.addEventListener('click', function(e) {
      e.preventDefault();
      var data = getFormData();
      var body = new FormData();
      body.append('html_content', data.html_content);
      body.append('css_content', data.css_content);
      body.append('document_type', data.document_type);
      body.append('csrfmiddlewaretoken', data.csrfmiddlewaretoken);
      fetch(previewDraftUrl, { method: 'POST', body: body, credentials: 'same-origin' })
        .then(function(r) { return r.text(); })
        .then(function(html) {
          var w = window.open('', '_blank');
          w.document.write(html);
          w.document.close();
        });
    });
  }

  if (iframe && (document.getElementById('html_content').value || document.getElementById('css_content').value)) {
    updatePreview();
  }
})();
</script>
{% endblock %}
