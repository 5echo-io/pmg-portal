{% load i18n static %}
<p class="muted">{% trans "Select which customers have access to this facility." %}</p>
<form method="post" action="{{ form_action }}" class="admin-form js-facility-modal-form facility-customers-modal-form">
  {% csrf_token %}
  {% if in_modal %}<input type="hidden" name="modal" value="1">{% endif %}
  <div class="facility-customers-modal-search">
    <input type="text" id="facility-customer-search" class="form-input facility-customers-modal-search-input" placeholder="{% trans 'Search customersâ€¦' %}" autocomplete="off" aria-label="{% trans 'Search customers' %}">
  </div>
  <div class="facility-customers-modal-list">
    {% for customer in all_customers %}
    <label class="facility-customer-card" data-customer-name="{{ customer.name|escape }}">
      <span class="facility-customer-card-inner">
        {% if customer.logo %}
        <span class="facility-customer-card-logo">
          <img src="{{ customer.logo.url }}" alt="" width="36" height="36">
        </span>
        {% else %}
        <span class="facility-customer-card-logo facility-customer-card-logo--placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <path d="M21 15l-5-5L5 21"></path>
          </svg>
        </span>
        {% endif %}
        <span class="facility-customer-card-content">
          <span class="facility-customer-card-name">{{ customer.name }}</span>
          {% if customer.org_number %}
          <span class="facility-customer-card-org muted">{% trans "Org. no." %}: {{ customer.org_number }}</span>
          {% endif %}
        </span>
        <span class="facility-customer-card-checkbox-wrap">
          <input type="checkbox" name="customers" value="{{ customer.pk }}" {% if customer.pk in selected_ids %}checked{% endif %} class="facility-customer-card-checkbox">
        </span>
      </span>
    </label>
    {% endfor %}
  </div>
  {% if form.customers.errors %}<p class="form-error">{{ form.customers.errors.0 }}</p>{% endif %}
  <div class="admin-form-actions">
    <button type="submit" class="form-btn form-btn-primary form-btn--narrow">{% trans "Save" %}</button>
    <button type="button" class="form-btn form-btn-secondary js-facility-modal-cancel">{% trans "Cancel" %}</button>
  </div>
</form>
<style>
.facility-customers-modal-search { margin-bottom: 12px; }
.facility-customers-modal-search-input { width: 100%; padding: 10px 14px; background: var(--bg); border: 1px solid var(--line); border-radius: 8px; font-size: 14px; }
.facility-customers-modal-list { max-height: 360px; overflow-y: auto; padding: 4px 0; }
.facility-customer-card { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 6px; cursor: pointer; transition: all 0.15s; margin-bottom: 4px; border: 1px solid transparent; }
.facility-customer-card:hover { background: var(--btn, rgba(0,0,0,0.04)); }
.facility-customer-card:last-child { margin-bottom: 0; }
.facility-customer-card-inner { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
.facility-customer-card-logo { width: 36px; height: 36px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: var(--bg); border-radius: 6px; border: 1px solid var(--line); overflow: hidden; }
.facility-customer-card-logo img { width: 100%; height: 100%; object-fit: contain; padding: 4px; }
.facility-customer-card-logo--placeholder { color: var(--muted); }
.facility-customer-card-content { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px; }
.facility-customer-card-name { font-size: 14px; font-weight: 500; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.facility-customer-card-org { font-size: 11px; }
.facility-customer-card-checkbox-wrap { flex-shrink: 0; }
.facility-customer-card-checkbox { width: 18px; height: 18px; cursor: pointer; }
.facility-customer-card.hidden { display: none !important; }
</style>
<script>
(function() {
  var searchInput = document.getElementById('facility-customer-search');
  var cards = document.querySelectorAll('.facility-customer-card');
  if (searchInput && cards.length) {
    searchInput.addEventListener('input', function() {
      var q = (this.value || '').toLowerCase().trim();
      cards.forEach(function(card) {
        var name = (card.getAttribute('data-customer-name') || '').toLowerCase();
        card.classList.toggle('hidden', q && name.indexOf(q) === -1);
      });
    });
  }
})();
</script>
